# æŠ€è¡“ä»•æ§˜æ›¸ v2.0

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
| æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|------|-----------|------|
| **Next.js** | 15.x | Reactãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆApp Routerï¼‰ |
| **React** | 19.x | UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª |
| **TypeScript** | 5.x | å‹å®‰å…¨ãªé–‹ç™º |
| **Tailwind CSS** | 3.x | ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆCSS |
| **GSAP** | 3.x | **é«˜åº¦ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³** â­ |
| **Framer Motion** | 11.x | Reactç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆè£œåŠ©ï¼‰ |
| **tsparticles** | 3.x | ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ |
| **react-type-animation** | - | ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ |
| **shadcn/ui** | - | UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
| **Radix UI** | - | ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«ãªãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ– |
| **Recharts** | 2.x | ãƒ‡ãƒ¼ã‚¿ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ |
| **@uiw/react-codemirror** | - | ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ |
| **Shiki** / **Prism.js** | - | ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ |

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
| æŠ€è¡“ | ç”¨é€” |
|------|------|
| **Next.js API Routes** | RESTful API |
| **Next.js Server Actions** | ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ |
| **Supabase** | PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ + èªè¨¼ |
| **Supabase Vector** | RAGç”¨ãƒ™ã‚¯ãƒˆãƒ«DB |
| **OpenAI API** | GPT-4o / GPT-4o-mini |
| **Vercel AI SDK** | AIçµ±åˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª |
| **Upstash Redis** | Rate Limiting |

### ã‚¤ãƒ³ãƒ•ãƒ©
| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” |
|----------|------|
| **Vercel** | ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ |
| **Supabase** | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»èªè¨¼ãƒ»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| **Upstash** | Redisï¼ˆRate Limitingï¼‰ |
| **OpenAI** | AI API |

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰                   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒãƒ£ãƒƒãƒˆç”»é¢ï¼‰                   â”‚  â”‚
â”‚  â”‚  - GSAP ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³                        â”‚  â”‚
â”‚  â”‚  - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ                      â”‚  â”‚
â”‚  â”‚  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Vercel (Next.js)                  â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  API Routes      â”‚      â”‚ Server Actions   â”‚   â”‚
â”‚  â”‚  /api/chat       â”‚      â”‚ - chatAction     â”‚   â”‚
â”‚  â”‚  /api/generate   â”‚      â”‚ - saveConv       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â†“                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI API      â”‚      â”‚      Supabase            â”‚
â”‚  - GPT-4o        â”‚      â”‚  - PostgreSQL            â”‚
â”‚  - Embeddings    â”‚      â”‚  - Vector (RAG)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  - Auth                  â”‚
                          â”‚  - Row Level Security    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Upstash Redis                           â”‚
â”‚              - Rate Limiting                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
portfolio20260125/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (public)/                    # å…¬é–‹ãƒšãƒ¼ã‚¸ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…±é€šï¼‰
â”‚   â”‚   â”œâ”€â”€ layout.tsx               # å…¬é–‹ãƒšãƒ¼ã‚¸ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”‚   â””â”€â”€ page.tsx                 # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒãƒ£ãƒƒãƒˆç”»é¢ï¼‰â­
â”‚   â”‚
â”‚   â”œâ”€â”€ (admin)/                     # ç®¡ç†ç”»é¢ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…±é€šï¼‰
â”‚   â”‚   â”œâ”€â”€ layout.tsx               # ç®¡ç†ç”»é¢ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚       â”œâ”€â”€ secret-entrance/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx         # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
â”‚   â”‚       â”œâ”€â”€ dashboard/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx         # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”‚       â”œâ”€â”€ conversations/
â”‚   â”‚       â”‚   â”œâ”€â”€ page.tsx         # ä¼šè©±å±¥æ­´ä¸€è¦§
â”‚   â”‚       â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â”‚       â””â”€â”€ page.tsx     # ä¼šè©±è©³ç´°
â”‚   â”‚       â”œâ”€â”€ visitors/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx         # è¨ªå•è€…ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ generated-sites/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx         # ã‚µã‚¤ãƒˆç”Ÿæˆãƒ­ã‚°
â”‚   â”‚       â”œâ”€â”€ ai-settings/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx         # AIè¨­å®š
â”‚   â”‚       â””â”€â”€ monitoring/
â”‚   â”‚           â””â”€â”€ page.tsx         # ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts             # ãƒãƒ£ãƒƒãƒˆAPIï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰
â”‚   â”‚   â”œâ”€â”€ generate-site/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts             # ã‚µã‚¤ãƒˆç”ŸæˆAPI
â”‚   â”‚   â”œâ”€â”€ visitor/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts             # è¨ªå•è€…è­˜åˆ¥API
â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚       â”œâ”€â”€ conversations/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts         # ä¼šè©±ãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚   â”‚       â””â”€â”€ stats/
â”‚   â”‚           â””â”€â”€ route.ts         # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚   â”‚
â”‚   â”œâ”€â”€ globals.css                  # ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â””â”€â”€ layout.tsx                   # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ ChatContainer.tsx        # ãƒãƒ£ãƒƒãƒˆå…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ
â”‚   â”‚   â”œâ”€â”€ ChatMessages.tsx         # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
â”‚   â”‚   â”œâ”€â”€ ChatMessage.tsx          # å˜ä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
â”‚   â”‚   â”œâ”€â”€ ChatInput.tsx            # å…¥åŠ›æ¬„
â”‚   â”‚   â”œâ”€â”€ TypingIndicator.tsx      # å…¥åŠ›ä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
â”‚   â”‚   â””â”€â”€ UsageLimitBanner.tsx     # ä½¿ç”¨åˆ¶é™ãƒãƒŠãƒ¼
â”‚   â”‚
â”‚   â”œâ”€â”€ site-preview/
â”‚   â”‚   â”œâ”€â”€ SitePreviewModal.tsx     # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
â”‚   â”‚   â”œâ”€â”€ CodeEditor.tsx           # ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
â”‚   â”‚   â”œâ”€â”€ PreviewFrame.tsx         # iframeãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
â”‚   â”‚   â””â”€â”€ PreviewControls.tsx      # æ“ä½œãƒœã‚¿ãƒ³
â”‚   â”‚
â”‚   â”œâ”€â”€ animations/
â”‚   â”‚   â”œâ”€â”€ ParticleBackground.tsx   # ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«èƒŒæ™¯
â”‚   â”‚   â”œâ”€â”€ TypingEffect.tsx         # ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
â”‚   â”‚   â”œâ”€â”€ GSAPTransitions.tsx      # GSAP ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³
â”‚   â”‚   â””â”€â”€ MessageAnimation.tsx     # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx              # ç®¡ç†ç”»é¢ã‚µã‚¤ãƒ‰ãƒãƒ¼
â”‚   â”‚   â”œâ”€â”€ StatsCard.tsx            # çµ±è¨ˆã‚«ãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ ConversationTable.tsx    # ä¼šè©±ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
â”‚   â”‚   â”œâ”€â”€ VisitorTable.tsx         # è¨ªå•è€…ãƒ†ãƒ¼ãƒ–ãƒ«
â”‚   â”‚   â”œâ”€â”€ SiteGallery.tsx          # ã‚µã‚¤ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼
â”‚   â”‚   â”œâ”€â”€ AISettings.tsx           # AIè¨­å®šãƒ•ã‚©ãƒ¼ãƒ 
â”‚   â”‚   â””â”€â”€ CostMonitor.tsx          # ã‚³ã‚¹ãƒˆãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
â”‚   â”‚
â”‚   â””â”€â”€ ui/                          # å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆshadcn/uiï¼‰
â”‚       â”œâ”€â”€ button.tsx
â”‚       â”œâ”€â”€ card.tsx
â”‚       â”œâ”€â”€ dialog.tsx
â”‚       â”œâ”€â”€ input.tsx
â”‚       â”œâ”€â”€ table.tsx
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts                # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨Supabase
â”‚   â”‚   â”œâ”€â”€ server.ts                # ã‚µãƒ¼ãƒãƒ¼ç”¨Supabase
â”‚   â”‚   â””â”€â”€ admin.ts                 # ç®¡ç†ç”¨Supabaseï¼ˆRLSå›é¿ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ openai/
â”‚   â”‚   â”œâ”€â”€ client.ts                # OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ chat.ts                  # ãƒãƒ£ãƒƒãƒˆå‡¦ç†
â”‚   â”‚   â”œâ”€â”€ site-generator.ts        # ã‚µã‚¤ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â””â”€â”€ embeddings.ts            # RAGç”¨ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°
â”‚   â”‚
â”‚   â”œâ”€â”€ rate-limit/
â”‚   â”‚   â””â”€â”€ redis.ts                 # Upstash Redisï¼ˆRate Limitingï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ visitor/
â”‚   â”‚   â”œâ”€â”€ identification.ts        # è¨ªå•è€…è­˜åˆ¥
â”‚   â”‚   â”œâ”€â”€ fingerprint.ts           # ãƒ–ãƒ©ã‚¦ã‚¶ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
â”‚   â”‚   â””â”€â”€ usage-tracking.ts        # ä½¿ç”¨é‡è¿½è·¡
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ format.ts                # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
â”‚   â”‚   â”œâ”€â”€ validation.ts            # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â””â”€â”€ date.ts                  # æ—¥ä»˜å‡¦ç†
â”‚   â”‚
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ chat.ts                  # ãƒãƒ£ãƒƒãƒˆå‹å®šç¾©
â”‚       â”œâ”€â”€ visitor.ts               # è¨ªå•è€…å‹å®šç¾©
â”‚       â”œâ”€â”€ generated-site.ts        # ç”Ÿæˆã‚µã‚¤ãƒˆå‹å®šç¾©
â”‚       â””â”€â”€ admin.ts                 # ç®¡ç†ç”»é¢å‹å®šç¾©
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useChat.ts                   # ãƒãƒ£ãƒƒãƒˆç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ useVisitor.ts                # è¨ªå•è€…è­˜åˆ¥ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ useGSAP.ts                   # GSAP ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒƒã‚¯
â”‚   â””â”€â”€ useConversations.ts          # ä¼šè©±å±¥æ­´ãƒ•ãƒƒã‚¯ï¼ˆç®¡ç†ç”»é¢ï¼‰
â”‚
â”œâ”€â”€ public/
â”‚   â””â”€â”€ images/
â”‚
â”œâ”€â”€ docs/                            # è¨­è¨ˆè³‡æ–™
â”œâ”€â”€ .env.local                       # ç’°å¢ƒå¤‰æ•°ï¼ˆGitç®¡ç†å¤–ï¼‰
â”œâ”€â”€ .env.example                     # ç’°å¢ƒå¤‰æ•°ã‚µãƒ³ãƒ—ãƒ«
â”œâ”€â”€ next.config.ts
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆSupabase PostgreSQLï¼‰

### ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
1. `visitors` - è¨ªå•è€…æƒ…å ±
2. `conversations` - ä¼šè©±å±¥æ­´
3. `messages` - å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
4. `generated_sites` - ç”Ÿæˆã•ã‚ŒãŸã‚µã‚¤ãƒˆ
5. `usage_limits` - ä½¿ç”¨åˆ¶é™ç®¡ç†
6. `admin_users` - ç®¡ç†è€…ï¼ˆçŸ³å·ã•ã‚“ã®ã¿ï¼‰
7. `ai_settings` - AIè¨­å®šï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç­‰ï¼‰
8. **`profile_data`** - **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆå‹•çš„ç·¨é›†å¯èƒ½ï¼‰** â­ NEW
9. **`character_patterns`** - **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å£èª¿ãƒ‘ã‚¿ãƒ¼ãƒ³** â­ NEW
10. **`profile_images`** - **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒç®¡ç†** â­ NEW
11. **`profile_mentions`** - **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨€åŠãƒ­ã‚°ï¼ˆåˆ†æç”¨ï¼‰** â­ NEW
12. `conversation_embeddings` - RAGç”¨ãƒ™ã‚¯ãƒˆãƒ«

---

### 1. visitorsï¼ˆè¨ªå•è€…æƒ…å ±ï¼‰

```sql
CREATE TABLE visitors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  visitor_id TEXT UNIQUE NOT NULL,         -- Cookie ID
  fingerprint TEXT,                         -- ãƒ–ãƒ©ã‚¦ã‚¶ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
  name TEXT,                                -- è¨ªå•è€…ã®åå‰ï¼ˆä»»æ„ï¼‰
  email TEXT,                               -- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰
  tier INTEGER DEFAULT 1,                   -- Tier (1-4)
  is_blocked BOOLEAN DEFAULT FALSE,         -- ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹
  visit_count INTEGER DEFAULT 0,            -- è¨ªå•å›æ•°
  total_messages INTEGER DEFAULT 0,         -- ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
  total_sites_generated INTEGER DEFAULT 0,  -- ç”Ÿæˆã‚µã‚¤ãƒˆæ•°
  last_seen_at TIMESTAMP DEFAULT NOW(),     -- æœ€çµ‚è¨ªå•æ—¥æ™‚
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_visitors_visitor_id ON visitors(visitor_id);
CREATE INDEX idx_visitors_fingerprint ON visitors(fingerprint);
CREATE INDEX idx_visitors_email ON visitors(email);
```

---

### 2. conversationsï¼ˆä¼šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

```sql
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  visitor_id UUID REFERENCES visitors(id) ON DELETE CASCADE,
  title TEXT,                               -- ä¼šè©±ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
  summary TEXT,                             -- è¦ç´„ï¼ˆAIãŒç”Ÿæˆï¼‰
  flag TEXT,                                -- 'prospect' | 'follow_up' | 'normal'
  admin_notes TEXT,                         -- ç®¡ç†è€…ãƒ¡ãƒ¢
  converted_to_inquiry BOOLEAN DEFAULT FALSE, -- å•ã„åˆã‚ã›ã«è»¢æ›ã—ãŸã‹
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_conversations_visitor_id ON conversations(visitor_id);
CREATE INDEX idx_conversations_flag ON conversations(flag);
CREATE INDEX idx_conversations_created_at ON conversations(created_at DESC);
```

---

### 3. messagesï¼ˆå€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

```sql
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
  role TEXT NOT NULL,                       -- 'user' | 'assistant' | 'system'
  content TEXT NOT NULL,                    -- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
  tokens_used INTEGER,                      -- ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  cost_usd DECIMAL(10, 6),                  -- ã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_messages_created_at ON messages(created_at DESC);

-- å…¨æ–‡æ¤œç´¢ç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_messages_content_search ON messages USING gin(to_tsvector('japanese', content));
```

---

### 4. generated_sitesï¼ˆç”Ÿæˆã•ã‚ŒãŸã‚µã‚¤ãƒˆï¼‰

```sql
CREATE TABLE generated_sites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
  visitor_id UUID REFERENCES visitors(id) ON DELETE CASCADE,
  requirements TEXT NOT NULL,               -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦ä»¶
  generated_code TEXT NOT NULL,             -- ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ï¼ˆHTML/CSS/JSï¼‰
  preview_image_url TEXT,                   -- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼ˆå°†æ¥çš„ï¼‰
  liked BOOLEAN DEFAULT FALSE,              -- ç®¡ç†è€…ãŒã€Œã„ã„ã­ã€ã—ãŸã‹
  tokens_used INTEGER,                      -- ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  cost_usd DECIMAL(10, 6),                  -- ã‚³ã‚¹ãƒˆ
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_generated_sites_visitor_id ON generated_sites(visitor_id);
CREATE INDEX idx_generated_sites_liked ON generated_sites(liked);
CREATE INDEX idx_generated_sites_created_at ON generated_sites(created_at DESC);
```

---

### 5. usage_limitsï¼ˆä½¿ç”¨åˆ¶é™ï¼‰

```sql
CREATE TABLE usage_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  visitor_id UUID REFERENCES visitors(id) ON DELETE CASCADE,
  date DATE NOT NULL,                       -- æ—¥ä»˜
  message_count INTEGER DEFAULT 0,          -- ãã®æ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
  site_generation_count INTEGER DEFAULT 0,  -- ãã®æ—¥ã®ã‚µã‚¤ãƒˆç”Ÿæˆæ•°
  UNIQUE(visitor_id, date)
);

CREATE INDEX idx_usage_limits_visitor_date ON usage_limits(visitor_id, date);
```

---

### 6. admin_usersï¼ˆç®¡ç†è€…ï¼‰

```sql
CREATE TABLE admin_users (
  id UUID PRIMARY KEY REFERENCES auth.users(id), -- Supabase Authã¨é€£æº
  email TEXT UNIQUE NOT NULL,
  display_name TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- çŸ³å·ã•ã‚“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ç™»éŒ²
```

---

### 7. ai_settingsï¼ˆAIè¨­å®šï¼‰

```sql
CREATE TABLE ai_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  version INTEGER NOT NULL,                 -- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·
  system_prompt TEXT NOT NULL,              -- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  model TEXT DEFAULT 'gpt-4o-mini',         -- ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«
  temperature DECIMAL(3, 2) DEFAULT 0.7,    -- Temperature
  max_tokens INTEGER DEFAULT 2000,          -- Max Tokens
  is_active BOOLEAN DEFAULT FALSE,          -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹
  created_by UUID REFERENCES admin_users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_ai_settings_active ON ai_settings(is_active);
```

---

### 8. profile_dataï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼‰â­ NEW

**ç›®çš„**: ç®¡ç†ç”»é¢ã‹ã‚‰ç·¨é›†å¯èƒ½ãªçŸ³å·ã•ã‚“ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ã—ã€AIã®ä¼šè©±ã«åæ˜ 

```sql
CREATE TABLE profile_data (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category TEXT NOT NULL,                   -- ã‚«ãƒ†ã‚´ãƒªï¼ˆ'basic', 'skills', 'achievements', 'hobbies', 'recent_updates'ï¼‰
  key TEXT NOT NULL,                        -- ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ï¼ˆä¾‹: 'bench_press', 'favorite_tech'ï¼‰
  value TEXT NOT NULL,                      -- å€¤ï¼ˆä¾‹: '100kg', 'Next.js'ï¼‰
  display_in_chat BOOLEAN DEFAULT TRUE,     -- ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã™ã‚‹ã‹
  priority INTEGER DEFAULT 0,               -- å„ªå…ˆåº¦ï¼ˆé«˜ã„ã»ã©ä¼šè©±ã§è§¦ã‚Œã‚„ã™ã„ï¼‰
  notes TEXT,                               -- å†…éƒ¨ãƒ¡ãƒ¢ï¼ˆã©ã†ä½¿ã†ã‹ç­‰ï¼‰
  updated_by UUID REFERENCES admin_users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(category, key)
);

CREATE INDEX idx_profile_category ON profile_data(category);
CREATE INDEX idx_profile_display ON profile_data(display_in_chat);
CREATE INDEX idx_profile_priority ON profile_data(priority DESC);

-- åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ä¾‹
INSERT INTO profile_data (category, key, value, display_in_chat, priority, notes) VALUES
  -- åŸºæœ¬æƒ…å ±
  ('basic', 'name', 'çŸ³å·æ•¦å¤§', TRUE, 100, 'æœ¬å'),
  ('basic', 'nickname', 'ã‚ã£ã¡ã‚ƒã‚“', TRUE, 100, 'æ„›ç§°'),
  ('basic', 'location', 'æ±äº¬éƒ½', TRUE, 50, 'æ‰€åœ¨åœ°'),
  ('basic', 'occupation', 'ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', TRUE, 90, 'è·æ¥­'),
  
  -- ã‚¹ã‚­ãƒ«
  ('skills', 'primary_stack', 'Next.js, TypeScript, Supabase', TRUE, 80, 'ãƒ¡ã‚¤ãƒ³ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯'),
  ('skills', 'years_experience', '5å¹´', TRUE, 70, 'å®Ÿå‹™çµŒé¨“å¹´æ•°'),
  
  -- è¶£å‘³ãƒ»å€‹æ€§
  ('hobbies', 'fitness', 'ç­‹ãƒˆãƒ¬ï¼ˆé€±5å›ï¼‰', TRUE, 60, 'è¶£å‘³'),
  ('hobbies', 'bench_press', '100kg', TRUE, 90, 'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹ã®è¨˜éŒ² - è©±é¡Œã«ã—ã‚„ã™ã„'),
  ('hobbies', 'reading', 'æŠ€è¡“æ›¸ã¨ãƒ“ã‚¸ãƒã‚¹æ›¸', TRUE, 40, 'èª­æ›¸'),
  
  -- æœ€è¿‘ã®å‡ºæ¥äº‹ï¼ˆé »ç¹ã«æ›´æ–°ï¼‰
  ('recent_updates', 'latest_achievement', 'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆ', TRUE, 95, '2026å¹´1æœˆé”æˆ'),
  ('recent_updates', 'current_learning', 'Rustè¨€èªã‚’å­¦ç¿’ä¸­', TRUE, 80, 'ç¾åœ¨å­¦ç¿’ä¸­ã®æŠ€è¡“'),
  ('recent_updates', 'recent_project', 'AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæ­è¼‰ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª', TRUE, 85, 'ã“ã®ã‚µã‚¤ãƒˆ'),
  
  -- å®Ÿç¸¾
  ('achievements', 'portfolio_users', '10ä¸‡äºº', TRUE, 70, 'éå»ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°'),
  ('achievements', 'github_stars', '500+', TRUE, 50, 'GitHubã‚¹ã‚¿ãƒ¼æ•°'),
  
  -- ãã®ä»–
  ('personality', 'work_style', 'é«˜é€Ÿé–‹ç™ºã¨ã‚¯ãƒªãƒ¼ãƒ³ãªã‚³ãƒ¼ãƒ‰', TRUE, 60, 'ä»•äº‹ã®ã‚¹ã‚¿ã‚¤ãƒ«'),
  ('personality', 'motto', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æœ€å„ªå…ˆ', TRUE, 70, 'ãƒ¢ãƒƒãƒˆãƒ¼');
```

#### ã‚«ãƒ†ã‚´ãƒªã®èª¬æ˜

| ã‚«ãƒ†ã‚´ãƒª | ç”¨é€” | ä¾‹ |
|---------|------|-----|
| `basic` | åŸºæœ¬æƒ…å ± | åå‰ã€è·æ¥­ã€æ‰€åœ¨åœ° |
| `skills` | æŠ€è¡“ã‚¹ã‚­ãƒ« | å¾—æ„æŠ€è¡“ã€çµŒé¨“å¹´æ•° |
| `hobbies` | è¶£å‘³ãƒ»å€‹æ€§ | ç­‹ãƒˆãƒ¬ã€èª­æ›¸ã€æ–™ç† |
| `recent_updates` | **æœ€è¿‘ã®å‡ºæ¥äº‹** | **ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹è¨˜éŒ²ã€å­¦ç¿’ä¸­ã®æŠ€è¡“** â­ |
| `achievements` | å®Ÿç¸¾ | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€å—è³æ­´ |
| `personality` | æ€§æ ¼ãƒ»ä¾¡å€¤è¦³ | ä»•äº‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€ãƒ¢ãƒƒãƒˆãƒ¼ |

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®èª¬æ˜

- **`display_in_chat`**: `TRUE` ã®å ´åˆã€AIãŒä¼šè©±ã§è¨€åŠå¯èƒ½
- **`priority`**: æ•°å€¤ãŒé«˜ã„ã»ã©ã€AIãŒç©æ¥µçš„ã«è©±é¡Œã«ã™ã‚‹ï¼ˆ0-100ï¼‰
  - 100: å¿…ãšç´¹ä»‹ã™ã‚‹ï¼ˆåå‰ã€è·æ¥­ï¼‰
  - 80-99: é »ç¹ã«è¨€åŠï¼ˆæœ€è¿‘ã®å‡ºæ¥äº‹ã€ä¸»è¦ã‚¹ã‚­ãƒ«ï¼‰
  - 50-79: é©åº¦ã«è¨€åŠï¼ˆè¶£å‘³ã€å®Ÿç¸¾ï¼‰
  - 0-49: è³ªå•ã•ã‚ŒãŸæ™‚ã®ã¿
- **`notes`**: ç®¡ç†è€…å‘ã‘ãƒ¡ãƒ¢ï¼ˆAIã«ã¯è¦‹ã›ãªã„ï¼‰

---

### 9. conversations_embeddingsï¼ˆRAGç”¨ãƒ™ã‚¯ãƒˆãƒ«ï¼‰

```sql
-- Supabase Vector æ‹¡å¼µã‚’æœ‰åŠ¹åŒ–
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE conversation_embeddings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
  content TEXT NOT NULL,                    -- æ¤œç´¢å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
  embedding VECTOR(1536),                   -- OpenAI Embeddings (1536æ¬¡å…ƒ)
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_embeddings_conversation ON conversation_embeddings(conversation_id);

-- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆivfflatï¼‰
CREATE INDEX idx_embeddings_vector ON conversation_embeddings 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

---

### 9. character_patternsï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å£èª¿ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰â­ NEW

**ç›®çš„**: ã‚ã£ã¡ã‚ƒã‚“AIã®å€‹æ€§çš„ãªå£èª¿ã‚’ç®¡ç†ã€‚1ä¼šè©±å†…ã§1ãƒ‘ã‚¿ãƒ¼ãƒ³å›ºå®šã€ä¼šè©±ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã€‚

```sql
CREATE TABLE character_patterns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT UNIQUE NOT NULL,                -- ãƒ‘ã‚¿ãƒ¼ãƒ³åï¼ˆä¾‹: 'gentle_pattern_1'ï¼‰
  description TEXT,                         -- èª¬æ˜ï¼ˆç®¡ç†ç”»é¢ã§è¡¨ç¤ºï¼‰
  theme TEXT,                               -- ãƒ†ãƒ¼ãƒï¼ˆ'gentle', 'energetic', 'mysterious'ç­‰ï¼‰
  is_active BOOLEAN DEFAULT TRUE,           -- ä½¿ç”¨ã™ã‚‹ã‹
  weight INTEGER DEFAULT 100,               -- é¸æŠç¢ºç‡ã®é‡ã¿ï¼ˆé«˜ã„ã»ã©é¸ã°ã‚Œã‚„ã™ã„ï¼‰
  
  -- å£èª¿ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆJSONå½¢å¼ï¼‰
  greeting TEXT,                            -- æŒ¨æ‹¶
  acknowledgment TEXT,                      -- ç›¸æ§Œ
  surprise TEXT,                            -- é©šã
  question TEXT,                            -- è³ªå•
  proposal TEXT,                            -- ææ¡ˆ
  agreement TEXT,                           -- äº†æ‰¿
  thinking TEXT,                            -- è€ƒãˆä¸­
  encouragement TEXT,                       -- åŠ±ã¾ã—
  gratitude TEXT,                           -- æ„Ÿè¬
  closing TEXT,                             -- ç· ã‚
  
  sentence_ending TEXT,                     -- èªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¾‹: 'ã€œãªã‚“ã ', 'ã€œã ã‚ˆ'ï¼‰
  particles TEXT,                           -- ä½¿ã†åŠ©è©ãƒ»æ„Ÿå˜†è©ï¼ˆä¾‹: 'ãµãµ', 'ãˆã¸ã¸'ï¼‰
  emoji_style TEXT,                         -- ä½¿ã†çµµæ–‡å­—ã®å‚¾å‘ï¼ˆä¾‹: 'âœ¨ğŸŒ¸ğŸ’«'ï¼‰
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_character_active ON character_patterns(is_active);
CREATE INDEX idx_character_weight ON character_patterns(weight DESC);

-- åˆæœŸãƒ‡ãƒ¼ã‚¿: ç©ã‚„ã‹ã§å„ªã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆ10ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
INSERT INTO character_patterns (name, description, theme, weight, greeting, acknowledgment, surprise, question, proposal, agreement, thinking, encouragement, gratitude, closing, sentence_ending, particles, emoji_style) VALUES
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãµã‚“ã‚ã‚Šå„ªã—ã„
  ('gentle_1', 'ãµã‚“ã‚ã‚Šå„ªã—ã„å£èª¿', 'gentle', 120,
   'ã“ã‚“ã«ã¡ã¯ã€œâœ¨ ãŠè©±ã—ã§ãã¦å¬‰ã—ã„ã§ã™',
   'ãªã‚‹ã»ã©ã€ãã†ãªã‚“ã§ã™ã­',
   'ã‚ãï¼ç´ æ•µãªã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã­',
   'ã©ã‚“ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ',
   'ã“ã‚“ãªæ„Ÿã˜ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ï¼Ÿ',
   'ã„ã„ã§ã™ã­ï¼ãœã²ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†',
   'ãµã‚€ãµã‚€...è€ƒãˆã¦ã¿ã¾ã™ã­',
   'å¤§ä¸ˆå¤«ã§ã™ã‚ˆã€ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†',
   'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€œ',
   'ã¾ãŸãŠè©±ã—ã§ãã‚‹ã®ã‚’æ¥½ã—ã¿ã«ã—ã¦ã¾ã™',
   'ã€œãªã‚“ã§ã™ã€ã€œã§ã™ã­ã€ã€œãªã‚“ã§ã™ã‚ˆ',
   'ãµãµã€ãˆã¸ã¸ã€ã‚ã',
   'âœ¨ğŸŒ¸ğŸ’«ğŸŒ¼'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒãƒãƒç³»ï¼ˆå…ƒæ°—ã ã‘ã©å„ªã—ã„ï¼‰
  ('gentle_2', 'ãƒãƒãƒç³»ã®ç‹¬ç‰¹ãªå£èª¿', 'gentle', 100,
   'ãƒãƒãƒã€ã“ã‚“ã«ã¡ã¯ã€œï¼',
   'ã»ã†ã»ã†ã€ãªã‚‹ã»ã©ãªã®ã§ã™',
   'ãŠãŠã€œï¼ãã‚Œã¯ç´ æ•µãªã‚“ã ï¼',
   'ã©ã‚“ãªé¢¨ã«ã—ãŸã„ã®ã‹ãªï¼Ÿ',
   'ã“ã†ã„ã†ã®ã¯ã©ã†ã§ã—ã‚‡ã†ã€œï¼Ÿ',
   'ã„ã„ã­ï¼ã‚„ã£ã¦ã¿ã‚‹ã‚“ã ï¼',
   'ã½ã‚€ã½ã‚€...è€ƒãˆä¸­ãªã®ã§ã™',
   'å¤§ä¸ˆå¤«ã€ãã£ã¨ã§ãã‚‹ã‚ˆï¼',
   'ã‚ã‚ŠãŒã¨ã†ãªã®ã§ã™ã€œ',
   'ã¾ãŸã­ã€œï¼',
   'ã€œãªã‚“ã ã€ã€œãªã®ã§ã™ã€ã€œã ã‚ˆ',
   'ãƒãƒãƒã€ã½ã‚€ã½ã‚€ã€ãµã«ã‚ƒ',
   'âœ¨ğŸ’«ğŸŒŸâ­'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã»ã‚“ã‚ã‹ç™’ã—ç³»
  ('gentle_3', 'ã»ã‚“ã‚ã‹ç™’ã—ç³»', 'gentle', 110,
   'ã“ã‚“ã«ã¡ã¯ã€ã‚†ã£ãã‚ŠãŠè©±ã—ã—ã¾ã—ã‚‡ã†ã­',
   'ãµã‚€ãµã‚€ã€ã‚ã‹ã‚Šã¾ã—ãŸ',
   'ã¾ãï¼ãã‚Œã¯é¢ç™½ãã†ã§ã™ã­',
   'ã©ã‚“ãªæ„Ÿã˜ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã•ã‚Œã¦ã¾ã™ã‹ï¼Ÿ',
   'ã“ã‚“ãªã®ã¯ã„ã‹ãŒã§ã™ã‹ã€œï¼Ÿ',
   'ã„ã„ã§ã™ã­ã€ç´ æ•µã§ã™',
   'ã†ãƒ¼ã‚“ã€è€ƒãˆã¦ã¿ã¾ã™ã­...',
   'ãã£ã¨å¤§ä¸ˆå¤«ã§ã™ã‚ˆ',
   'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
   'ã¾ãŸãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã­',
   'ã€œã§ã™ã­ã€ã€œã¾ã™ã­ã€ã€œã§ã™ã‚ˆ',
   'ãµãµã€ã†ãµãµã€ã¾ã',
   'ğŸŒ¸ğŸŒ·ğŸŒºğŸ’'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãŠå§‰ã•ã‚“ç³»å„ªã—ã„
  ('gentle_4', 'ãŠå§‰ã•ã‚“ç³»ã®å„ªã—ã„å£èª¿', 'gentle', 100,
   'ã„ã‚‰ã£ã—ã‚ƒã„â™ª ã©ã†ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ',
   'ãªã‚‹ã»ã©ã­ã€ã‚ã‹ã‚Šã¾ã—ãŸ',
   'ã¸ã‡ã€œï¼ã„ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã­',
   'ã‚‚ã†å°‘ã—è©³ã—ãèã‹ã›ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ',
   'ã“ã†ã„ã†ã®ã¯ã©ã†ã‹ã—ã‚‰ï¼Ÿ',
   'ã„ã„ã‚ã­ï¼ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†',
   'ãã†ã­...ã¡ã‚‡ã£ã¨è€ƒãˆã¦ã¿ã‚‹ã‚',
   'å¤§ä¸ˆå¤«ã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†',
   'ã‚ã‚ŠãŒã¨ã†ã­',
   'ã¾ãŸæ¥ã¦ãã ã•ã„ã­',
   'ã€œã­ã€ã€œã‚ã€ã€œã‹ã—ã‚‰',
   'ãµãµã€ã‚ã‚‰ã€ã¾ã',
   'ğŸ’•âœ¨ğŸŒ¸ğŸ’–'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³5: ãµã‚ãµã‚ä¸æ€è­°ç³»
  ('gentle_5', 'ãµã‚ãµã‚ã—ãŸä¸æ€è­°ãªå£èª¿', 'gentle', 90,
   'ãµã‚ãµã‚ã€œã“ã‚“ã«ã¡ã¯',
   'ã»ã»ã…ã€ãã†ãªã®ã§ã™ã‹',
   'ã‚ãã€ã‚­ãƒ©ã‚­ãƒ©ã—ã¦ã¾ã™ã­',
   'ã©ã‚“ãªä¸–ç•Œã‚’ä½œã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ',
   'ã“ã‚“ãªæ„Ÿã˜ã¯ã©ã†ã§ã—ã‚‡ã†ã€œï¼Ÿ',
   'ã„ã„ã§ã™ã­ã€ãã£ã¨ç´ æ•µã«ãªã‚Šã¾ã™',
   'ãµã‚€ãµã‚€...ãµã‚ã€œ',
   'ãã£ã¨ã†ã¾ãã„ãã¾ã™ã‚ˆ',
   'ã‚ã‚ŠãŒã¨ã†ã§ã™ã€œ',
   'ã¾ãŸãµã‚ãµã‚ã—ã¾ã—ã‚‡ã†',
   'ã€œã§ã™ã‚ˆã€ã€œãªã®ã§ã™ã€ã€œã¾ã™ã­',
   'ãµã‚ãµã‚ã€ãµã‚€ãµã‚€ã€ãã‚‰ãã‚‰',
   'âœ¨ğŸ’«ğŸŒ™â­'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³6: ä¸å¯§ã§ç©ã‚„ã‹
  ('gentle_6', 'ä¸å¯§ã§ç©ã‚„ã‹ãªå£èª¿', 'gentle', 105,
   'ã“ã‚“ã«ã¡ã¯ã€‚ãŠè©±ã—ã§ãã¦å¬‰ã—ã„ã§ã™',
   'ãªã‚‹ã»ã©ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸ',
   'ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼',
   'ã©ã®ã‚ˆã†ãªã‚‚ã®ã‚’ãŠè€ƒãˆã§ã—ã‚‡ã†ã‹ï¼Ÿ',
   'ã“ã®ã‚ˆã†ãªå½¢ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ï¼Ÿ',
   'ã‚ˆã„ã§ã™ã­ã€é€²ã‚ã¦ã¾ã„ã‚Šã¾ã—ã‚‡ã†',
   'ãã†ã§ã™ã­...å°‘ã€…ãŠå¾…ã¡ãã ã•ã„',
   'ã”å®‰å¿ƒãã ã•ã„ã€ãŠæ‰‹ä¼ã„ã—ã¾ã™',
   'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
   'ã¾ãŸãŠè©±ã—ã§ãã‚‹ã®ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™',
   'ã€œã§ã™ã€ã€œã¾ã™ã€ã€œã§ã—ã‚‡ã†',
   'ãµãµã€ãˆãˆã€ã¯ã„',
   'âœ¨ğŸŒ¸ğŸ€ğŸ’'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³7: ã¡ã‚‡ã£ã¨ãŠã£ã¨ã‚Š
  ('gentle_7', 'ãŠã£ã¨ã‚Šã—ãŸå„ªã—ã„å£èª¿', 'gentle', 95,
   'ã‚ã€ã“ã‚“ã«ã¡ã¯ã€œ',
   'ã¸ã‡ã€œã€ãã†ãªã‚“ã§ã™ã­',
   'ã‚ãã€ãã‚Œã¯ã„ã„ã§ã™ã­ã€œ',
   'ã†ãƒ¼ã‚“ã€ã©ã‚“ãªæ„Ÿã˜ã§ã—ã‚‡ã†ï¼Ÿ',
   'ã“ã†ã„ã†ã®ã¨ã‹ã€ã©ã†ã§ã™ã‹ã€œï¼Ÿ',
   'ã„ã„ã¨æ€ã„ã¾ã™ã€œ',
   'ã†ãƒ¼ã‚“...ã¡ã‚‡ã£ã¨è€ƒãˆã¾ã™ã­',
   'å¤§ä¸ˆå¤«ã§ã™ã‚ˆã€œ',
   'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
   'ã¾ãŸã§ã™ã­ã€œ',
   'ã€œã§ã™ã­ã€ã€œã¾ã™ã€ã€œã§ã™ã‚ˆ',
   'ã†ãƒ¼ã‚“ã€ã¸ã‡ã€ã‚ãƒ¼',
   'ğŸŒ¸ğŸ’ğŸŒ¼ğŸŒ»'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³8: ã¡ã‚‡ã£ã´ã‚Šãƒ†ãƒ³ã‚·ãƒ§ãƒ³é«˜ã‚å„ªã—ã„
  ('gentle_8', 'ãƒ†ãƒ³ã‚·ãƒ§ãƒ³é«˜ã‚ã ã‘ã©å„ªã—ã„', 'gentle', 100,
   'ã“ã‚“ã«ã¡ã¯ã€œï¼ãŠä¼šã„ã§ãã¦å¬‰ã—ã„ã§ã™ï¼',
   'ãªã‚‹ã»ã©ï¼ã‚ã‹ã‚Šã¾ã—ãŸï¼',
   'ã‚ãï¼ã™ã”ãã„ã„ã§ã™ã­ï¼',
   'ã©ã‚“ãªã®ãŒã„ã„ã§ã™ã‹ã€œï¼Ÿ',
   'ã“ã‚“ãªæ„Ÿã˜ã¯ã©ã†ã§ã—ã‚‡ã†ï¼',
   'ã„ã„ã§ã™ã­ï¼æ¥½ã—ã¿ã§ã™ï¼',
   'ãµã‚€ãµã‚€...ï¼',
   'ãã£ã¨ã†ã¾ãã„ãã¾ã™ã‚ˆï¼',
   'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€œï¼',
   'ã¾ãŸãŠè©±ã—ã—ã¾ã—ã‚‡ã†ã­ï¼',
   'ã€œã§ã™ï¼ã€ã€œã¾ã™ã­ï¼ã€ã€œã§ã™ã‚ˆï¼',
   'ã‚ãã€ãµãµã€ãˆã¸ã¸',
   'âœ¨ğŸ’–ğŸŒŸğŸ’•'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³9: ã—ã£ã¨ã‚Šè½ã¡ç€ã„ãŸå„ªã—ã•
  ('gentle_9', 'è½ã¡ç€ã„ãŸå¤§äººã®å„ªã—ã•', 'gentle', 95,
   'ã“ã‚“ã«ã¡ã¯ã€‚ã”ã‚†ã£ãã‚Šã©ã†ã',
   'ãªã‚‹ã»ã©ã€æ‰¿çŸ¥ã—ã¾ã—ãŸ',
   'ãã‚Œã¯èˆˆå‘³æ·±ã„ã§ã™ã­',
   'ã©ã®ã‚ˆã†ã«ãŠè€ƒãˆã§ã™ã‹ï¼Ÿ',
   'ã“ã¡ã‚‰ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹',
   'ã‚ˆã‚ã—ã„ã§ã™ã­',
   'ãã†ã§ã™ã­...å°‘ã—ãŠå¾…ã¡ã‚’',
   'ã”å¿ƒé…ãªãã€ãŠä»»ã›ãã ã•ã„',
   'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
   'ã¾ãŸã®ã”æ¥è¨ªã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™',
   'ã€œã§ã™ã€ã€œã¾ã™ã€ã€œã§ã™ã­',
   'ãµã‚€ã€ãˆãˆã€ã•ã¦',
   'ğŸŒ¸ğŸƒâœ¨ğŸŒ™'),
  
  -- ãƒ‘ã‚¿ãƒ¼ãƒ³10: ã»ã‚“ã®ã‚Šç”˜ãˆç³»å„ªã—ã„
  ('gentle_10', 'ã»ã‚“ã®ã‚Šç”˜ãˆã®ã‚ã‚‹å„ªã—ã•', 'gentle', 100,
   'ã“ã‚“ã«ã¡ã¯ã€œ ä¼šãˆã¦å¬‰ã—ã„ãª',
   'ã†ã‚“ã†ã‚“ã€ãªã‚‹ã»ã©ã­',
   'ã‚ãã€ãã‚Œã„ã„ã­ï¼',
   'ã©ã‚“ãªã®ãŒã„ã„ã‹ãªï¼Ÿ',
   'ã“ã‚“ãªã®ã¯ã©ã†ï¼Ÿ',
   'ã„ã„ã­ï¼ã‚„ã£ã¦ã¿ã‚ˆã†',
   'ã‚“ãƒ¼...è€ƒãˆã¦ã‚‹ã­',
   'å¤§ä¸ˆå¤«ã ã‚ˆã€ä»»ã›ã¦',
   'ã‚ã‚ŠãŒã¨ã†ã€œ',
   'ã¾ãŸã­ï¼å¾…ã£ã¦ã‚‹ã­',
   'ã€œã ã‚ˆã€ã€œã ã­ã€ã€œã‹ãª',
   'ãˆã¸ã¸ã€ã†ãµãµã€ã‚“ãƒ¼',
   'ğŸ’•âœ¨ğŸŒ¸ğŸ’–');

-- æ³¨: å®Ÿè£…æ™‚ã«çŸ³å·ã•ã‚“ã®å¥½ã¿ã«å¿œã˜ã¦èª¿æ•´ãƒ»è¿½åŠ 
```

#### ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ§‹é€ 

| ã‚«ãƒ©ãƒ  | èª¬æ˜ | ä¾‹ |
|--------|------|-----|
| `name` | ãƒ‘ã‚¿ãƒ¼ãƒ³ID | `gentle_1`, `gentle_2` |
| `description` | ç®¡ç†ç”»é¢ã§è¡¨ç¤ºã™ã‚‹èª¬æ˜ | ã€Œãµã‚“ã‚ã‚Šå„ªã—ã„å£èª¿ã€ |
| `theme` | ãƒ†ãƒ¼ãƒåˆ†é¡ | `gentle`ï¼ˆå…¨ã¦ç©ã‚„ã‹ã§å„ªã—ã„ï¼‰ |
| `weight` | é¸æŠç¢ºç‡ã®é‡ã¿ | 120ï¼ˆé«˜ã„ï¼‰ã€œ90ï¼ˆä½ã„ï¼‰ |
| `greeting` ã€œ `closing` | ã‚·ãƒ¼ãƒ³åˆ¥ã®å®šå‹æ–‡ | å„10ç¨®é¡ |
| `sentence_ending` | èªå°¾ã®ç‰¹å¾´ | ã€Œã€œãªã‚“ã ã€ã€Œã€œã§ã™ã­ã€ |
| `particles` | ä½¿ã†æ„Ÿå˜†è© | ã€Œãƒãƒãƒã€ã€Œãµãµã€ |
| `emoji_style` | çµµæ–‡å­—ã®å‚¾å‘ | ã€Œâœ¨ğŸŒ¸ğŸ’«ã€ |

---

### 10. profile_imagesï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒç®¡ç†ï¼‰â­ NEW

**ç›®çš„**: è¤‡æ•°ã®ä¸¸å‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’ç®¡ç†ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºã€‚

```sql
CREATE TABLE profile_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  image_url TEXT NOT NULL,                  -- Supabase Storage URL
  alt_text TEXT,                            -- ç”»åƒã®èª¬æ˜
  is_active BOOLEAN DEFAULT TRUE,           -- ä½¿ç”¨ã™ã‚‹ã‹
  weight INTEGER DEFAULT 100,               -- é¸æŠç¢ºç‡ã®é‡ã¿
  category TEXT,                            -- ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³: 'normal', 'smiling', 'thinking'ï¼‰
  upload_date TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_profile_images_active ON profile_images(is_active);

-- ä¾‹: 5ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç”»åƒã‚’ç™»éŒ²
INSERT INTO profile_images (image_url, alt_text, category, weight) VALUES
  ('https://your-supabase.storage.co/avatars/avatar_1.png', 'ã‚ã£ã¡ã‚ƒã‚“ï¼ˆç¬‘é¡”ï¼‰', 'smiling', 100),
  ('https://your-supabase.storage.co/avatars/avatar_2.png', 'ã‚ã£ã¡ã‚ƒã‚“ï¼ˆè€ƒãˆä¸­ï¼‰', 'thinking', 100),
  ('https://your-supabase.storage.co/avatars/avatar_3.png', 'ã‚ã£ã¡ã‚ƒã‚“ï¼ˆã‚¦ã‚£ãƒ³ã‚¯ï¼‰', 'normal', 100),
  ('https://your-supabase.storage.co/avatars/avatar_4.png', 'ã‚ã£ã¡ã‚ƒã‚“ï¼ˆçœŸé¢ç›®ï¼‰', 'normal', 100),
  ('https://your-supabase.storage.co/avatars/avatar_5.png', 'ã‚ã£ã¡ã‚ƒã‚“ï¼ˆå…ƒæ°—ï¼‰', 'normal', 100);
```

---

### 11. profile_mentionsï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨€åŠãƒ­ã‚°ï¼‰â­ NEW

**ç›®çš„**: AIãŒã©ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¼šè©±ã§è¨€åŠã—ãŸã‹ã‚’è¨˜éŒ²ã—ã€åˆ†æã«æ´»ç”¨ã€‚

```sql
CREATE TABLE profile_mentions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
  message_id UUID REFERENCES messages(id) ON DELETE CASCADE,
  profile_item_category TEXT NOT NULL,      -- è¨€åŠã—ãŸã‚«ãƒ†ã‚´ãƒª
  profile_item_key TEXT NOT NULL,           -- è¨€åŠã—ãŸã‚­ãƒ¼ï¼ˆä¾‹: 'bench_press'ï¼‰
  visitor_reaction TEXT,                    -- è¨ªå•è€…ã®åå¿œï¼ˆæ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æ¨æ¸¬ï¼‰
  reaction_sentiment TEXT,                  -- 'positive', 'neutral', 'negative'
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_mentions_conversation ON profile_mentions(conversation_id);
CREATE INDEX idx_mentions_profile_key ON profile_mentions(profile_item_key);
CREATE INDEX idx_mentions_created_at ON profile_mentions(created_at DESC);

-- åˆ†æç”¨ã®ãƒ“ãƒ¥ãƒ¼
CREATE VIEW profile_mention_stats AS
SELECT 
  profile_item_key,
  COUNT(*) as mention_count,
  COUNT(CASE WHEN reaction_sentiment = 'positive' THEN 1 END) as positive_reactions,
  COUNT(CASE WHEN reaction_sentiment = 'positive' THEN 1 END)::FLOAT / COUNT(*) as positive_rate,
  MAX(created_at) as last_mentioned_at
FROM profile_mentions
GROUP BY profile_item_key
ORDER BY mention_count DESC;
```

---

### 12. conversation_embeddingsï¼ˆRAGç”¨ãƒ™ã‚¯ãƒˆãƒ«ï¼‰

### visitors ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
-- å…¨å“¡ãŒè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’é–²è¦§å¯èƒ½
ALTER TABLE visitors ENABLE ROW LEVEL SECURITY;

CREATE POLICY "è¨ªå•è€…ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’é–²è¦§å¯èƒ½" ON visitors
  FOR SELECT
  USING (visitor_id = current_setting('app.visitor_id', true));

-- ç®¡ç†è€…ã¯å…¨ã¦é–²è¦§ãƒ»ç·¨é›†å¯èƒ½
CREATE POLICY "ç®¡ç†è€…ã¯å…¨ã¦é–²è¦§å¯èƒ½" ON visitors
  FOR ALL
  USING (auth.uid() IN (SELECT id FROM admin_users));
```

### conversations / messages ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- è¨ªå•è€…ã¯è‡ªåˆ†ã®ä¼šè©±ã®ã¿é–²è¦§
CREATE POLICY "è¨ªå•è€…ã¯è‡ªåˆ†ã®ä¼šè©±ã‚’é–²è¦§å¯èƒ½" ON conversations
  FOR SELECT
  USING (visitor_id IN (SELECT id FROM visitors WHERE visitor_id = current_setting('app.visitor_id', true)));

-- ç®¡ç†è€…ã¯å…¨ã¦
CREATE POLICY "ç®¡ç†è€…ã¯å…¨ã¦é–²è¦§å¯èƒ½" ON conversations
  FOR ALL
  USING (auth.uid() IN (SELECT id FROM admin_users));
```

### ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚åŒæ§˜ã«è¨­å®š

---

## APIè¨­è¨ˆ

### 1. ãƒãƒ£ãƒƒãƒˆAPIï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰

**Endpoint**: `POST /api/chat`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  message: string;                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  conversationId?: string;            // ä¼šè©±IDï¼ˆç¶™ç¶šã®å ´åˆï¼‰
  visitorId: string;                  // è¨ªå•è€…ID
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰:**
```typescript
// Server-Sent Events (SSE)
data: {"type": "token", "content": "ã“ã‚“ã«ã¡ã¯"}
data: {"type": "token", "content": "ï¼"}
data: {"type": "done", "conversationId": "abc123"}
```

**å®Ÿè£…:**
```typescript
// app/api/chat/route.ts
import { OpenAIStream, StreamingTextResponse } from 'ai';
import { openai } from '@/lib/openai/client';

export async function POST(req: Request) {
  const { message, conversationId, visitorId } = await req.json();
  
  // ä½¿ç”¨åˆ¶é™ãƒã‚§ãƒƒã‚¯
  const canUse = await checkUsageLimit(visitorId);
  if (!canUse) {
    return Response.json({ error: 'limit_reached' }, { status: 429 });
  }
  
  // ä¼šè©±å±¥æ­´å–å¾—
  const history = await getConversationHistory(conversationId);
  
  // OpenAI APIå‘¼ã³å‡ºã—
  const response = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [
      { role: 'system', content: getSystemPrompt() },
      ...history,
      { role: 'user', content: message }
    ],
    stream: true,
  });
  
  // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  const stream = OpenAIStream(response, {
    onCompletion: async (completion) => {
      // ä¼šè©±ã‚’DBã«ä¿å­˜
      await saveMessage(conversationId, 'user', message);
      await saveMessage(conversationId, 'assistant', completion);
      await incrementUsage(visitorId);
    }
  });
  
  return new StreamingTextResponse(stream);
}
```

---

### 2. ã‚µã‚¤ãƒˆç”ŸæˆAPI

**Endpoint**: `POST /api/generate-site`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  requirements: string;               // ã‚µã‚¤ãƒˆã®è¦ä»¶
  conversationId: string;             // ä¼šè©±ID
  visitorId: string;                  // è¨ªå•è€…ID
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  code: string;                       // ç”Ÿæˆã•ã‚ŒãŸHTML/CSS/JS
  preview_url: string;                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  tokens_used: number;                // ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  estimated_cost: number;             // ã‚³ã‚¹ãƒˆ
}
```

**å®Ÿè£…:**
```typescript
// app/api/generate-site/route.ts
export async function POST(req: Request) {
  const { requirements, conversationId, visitorId } = await req.json();
  
  // Tier 2ä»¥ä¸Šã‹ãƒã‚§ãƒƒã‚¯
  const visitor = await getVisitor(visitorId);
  if (visitor.tier < 2) {
    return Response.json({ error: 'upgrade_required' }, { status: 403 });
  }
  
  // ã‚µã‚¤ãƒˆç”Ÿæˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
  const canGenerate = await checkSiteGenerationLimit(visitorId);
  if (!canGenerate) {
    return Response.json({ error: 'limit_reached' }, { status: 429 });
  }
  
  // GPT-4o ã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
  const code = await generateSiteCode(requirements);
  
  // DBã«ä¿å­˜
  await saveGeneratedSite({
    conversation_id: conversationId,
    visitor_id: visitor.id,
    requirements,
    generated_code: code,
  });
  
  return Response.json({ code });
}
```

---

### 3. è¨ªå•è€…è­˜åˆ¥API

**Endpoint**: `POST /api/visitor`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  fingerprint: string;                // ãƒ–ãƒ©ã‚¦ã‚¶ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  visitorId: string;                  // è¨ªå•è€…IDï¼ˆCookieè¨­å®šï¼‰
  tier: number;                       // Tier
  remainingMessages: number;          // æ®‹ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°
}
```

---

## è¨ªå•è€…è­˜åˆ¥ã®ä»•çµ„ã¿ï¼ˆCookie + Fingerprintingï¼‰

### ãªãœå¿…è¦ãªã®ã‹ï¼Ÿ

ã“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆã§ã¯ã€**ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§è¨ªå•è€…ã‚’è­˜åˆ¥**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ç›®çš„:**
1. **ä½¿ç”¨åˆ¶é™ã®ç®¡ç†** - ç„¡æ–™æ ï¼ˆ1æ—¥5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç­‰ï¼‰ã‚’é©ç”¨ã™ã‚‹ãŸã‚
2. **ä¼šè©±å±¥æ­´ã®å¾©å…ƒ** - å†è¨ªå•æ™‚ã«ã€ŒãŠã‹ãˆã‚Šãªã•ã„ã€ç”°ä¸­ã•ã‚“ï¼ã€ã¨è¿ãˆã‚‹ãŸã‚
3. **æ‚ªç”¨é˜²æ­¢** - ç„¡é™ã«OpenAI APIã‚’ä½¿ã‚ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚
4. **è¨ªå•è€…ãƒ‡ãƒ¼ã‚¿ã®è“„ç©** - ç®¡ç†ç”»é¢ã§ä¼šè©±å±¥æ­´ã‚’ç¢ºèªã™ã‚‹ãŸã‚

**ãªãœãƒ­ã‚°ã‚¤ãƒ³ã§ã¯ãƒ€ãƒ¡ãªã®ã‹ï¼Ÿ**
- ãƒ­ã‚°ã‚¤ãƒ³ã¯è¨ªå•è€…ã«ã¨ã£ã¦**ãƒãƒ¼ãƒ‰ãƒ«ãŒé«˜ã„**
- ã€Œã¾ãšã¯æ°—è»½ã«è©¦ã—ãŸã„ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿ƒç†ã‚’å°Šé‡
- ã€Œè©¦ã—ã¦ã‹ã‚‰ç™»éŒ²ã€ã®ã»ã†ãŒã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ãŒé«˜ã„

---

### Cookie + Fingerprinting ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼

#### ä»•çµ„ã¿ã®å…¨ä½“åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¨ªå•è€…ãŒã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘  CookieãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª                                 â”‚
â”‚     - localStorage ã« visitor_id ãŒã‚ã‚‹ã‹ï¼Ÿ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ YES                       â”‚ NO
            â†“                           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Cookieã‹ã‚‰        â”‚      â”‚ â‘¡ Fingerprintã‚’ç”Ÿæˆ    â”‚
  â”‚ visitor_idå–å¾—    â”‚      â”‚  (FingerprintJS.load()) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                           â”‚
            â”‚                           â†“
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚ â‘¢ DBã§Fingerprintæ¤œç´¢   â”‚
            â”‚              â”‚   æ—¢å­˜ã®è¨ªå•è€…ã‹ï¼Ÿ       â”‚
            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                           â”‚
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚ æ—¢å­˜          â”‚ æ–°è¦    â”‚
            â”‚              â†“               â†“
            â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      â”‚ æ—¢å­˜IDã‚’è¿”ã™ â”‚  â”‚ æ–°è¦IDç™ºè¡Œ   â”‚
            â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚              â”‚               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ visitor_id ã‚’ Cookie ã«ä¿å­˜       â”‚
          â”‚ (localStorage ã«ä¿å­˜)             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã«           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Cookieã¨ã¯ï¼Ÿ

**ç°¡å˜ã«è¨€ã†ã¨**: ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã‚‹ã€Œåæœ­ã€

- ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeã€Safariç­‰ï¼‰ã«ä¿å­˜ã•ã‚Œã‚‹å°ã•ãªãƒ‡ãƒ¼ã‚¿
- ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ID: abc123ã§ã™ã€ã¨ã„ã†æƒ…å ±ã‚’ä¿å­˜
- æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«è‡ªå‹•çš„ã«é€ä¿¡ã•ã‚Œã‚‹

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… ã‚·ãƒ³ãƒ—ãƒ«ã§é«˜é€Ÿ
- âœ… æ¨™æº–çš„ãªæŠ€è¡“ï¼ˆå…¨ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œï¼‰
- âœ… ã‚µãƒ¼ãƒãƒ¼å´ã§ç°¡å˜ã«èª­ã¿å–ã‚Œã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã§ãã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ï¼‰
- âŒ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰ã§ã¯æ¶ˆãˆã‚‹
- âŒ ç•°ãªã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯åˆ¥äººæ‰±ã„ï¼ˆChrome â‰  Safariï¼‰

**å®Ÿè£…ä¾‹:**
```typescript
// Cookieã«è¨ªå•è€…IDã‚’ä¿å­˜
document.cookie = `visitor_id=abc123; max-age=${60 * 60 * 24 * 365}; path=/`;

// Cookieã‹ã‚‰è¨ªå•è€…IDã‚’å–å¾—
const visitorId = document.cookie
  .split('; ')
  .find(row => row.startsWith('visitor_id='))
  ?.split('=')[1];
```

---

### Fingerprintã¨ã¯ï¼Ÿ

**ç°¡å˜ã«è¨€ã†ã¨**: ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œé¡”èªè¨¼ã€

- ãƒ–ãƒ©ã‚¦ã‚¶ã‚„ãƒ‡ãƒã‚¤ã‚¹ã®**ç‰¹å¾´çš„ãªæƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã¦**ç”Ÿæˆã™ã‚‹ä¸€æ„ã®ID
- CookieãŒå‰Šé™¤ã•ã‚Œã¦ã‚‚ã€åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰åŒã˜IDãŒç”Ÿæˆã•ã‚Œã‚‹
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ã¯ãªãã€æƒ…å ±ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰è¨ˆç®—**ã™ã‚‹

#### ä½•ã®æƒ…å ±ã‚’ä½¿ã†ã®ã‹ï¼Ÿ

FingerprintJSãŒåé›†ã™ã‚‹æƒ…å ±ï¼ˆä¸€éƒ¨ï¼‰:
```typescript
{
  userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...",
  screenResolution: "2560x1440",
  timezone: "Asia/Tokyo",
  language: "ja-JP",
  platform: "MacIntel",
  colorDepth: 24,
  installedFonts: ["Arial", "Helvetica", "Times New Roman", ...],
  canvas: "a8b3c9d2...",  // Canvas Fingerprinting
  webGL: "e5f1g7h8...",    // WebGL Fingerprinting
  audio: "k2l4m6n8...",    // Audio Fingerprinting
  // ... ãªã©50ç¨®é¡ä»¥ä¸Šã®æƒ…å ±
}
```

ã“ã‚Œã‚‰ã®æƒ…å ±ã‚’**ãƒãƒƒã‚·ãƒ¥åŒ–**ã—ã¦ä¸€æ„ã®IDã‚’ç”Ÿæˆ:
```typescript
fingerprint = hash(userAgent + screen + timezone + fonts + ...)
// çµæœ: "a7b3c9d2e5f1g8h4i6j2k9l1m3n5o7p8"
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… CookieãŒå‰Šé™¤ã•ã‚Œã¦ã‚‚è­˜åˆ¥å¯èƒ½
- âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ï¼ˆã‚ã‚‹ç¨‹åº¦ï¼‰è­˜åˆ¥å¯èƒ½
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ„å›³çš„ã«æ¶ˆã›ãªã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âŒ 100%æ­£ç¢ºã§ã¯ãªã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç­‰ã§å¤‰ã‚ã‚‹å¯èƒ½æ€§ï¼‰
- âŒ è¨ˆç®—ã‚³ã‚¹ãƒˆãŒã‚„ã‚„é«˜ã„
- âŒ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æ‡¸å¿µï¼ˆéåº¦ãªè¿½è·¡ã¨è¦‹ãªã•ã‚Œã‚‹å¯èƒ½æ€§ï¼‰

**å®Ÿè£…ä¾‹:**
```typescript
// FingerprintJS v4
import FingerprintJS from '@fingerprintjs/fingerprintjs';

// åˆå›ã®ã¿ãƒ­ãƒ¼ãƒ‰ï¼ˆéåŒæœŸï¼‰
const fp = await FingerprintJS.load();

// Fingerprintç”Ÿæˆ
const result = await fp.get();
const fingerprint = result.visitorId; // "a7b3c9d2e5f1..."

console.log(fingerprint); // åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰å¸¸ã«åŒã˜å€¤
```

---

### ãªãœCookie + Fingerprintã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãªã®ã‹ï¼Ÿ

| ã‚·ãƒŠãƒªã‚ª | Cookieã®ã¿ | Fingerprintã®ã¿ | **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰** |
|---------|-----------|----------------|----------------|
| **é€šå¸¸åˆ©ç”¨** | âœ… æ­£å¸¸å‹•ä½œ | âœ… æ­£å¸¸å‹•ä½œ | âœ… **é«˜é€Ÿï¼†æ­£ç¢º** |
| **Cookieå‰Šé™¤** | âŒ åˆ¥äººæ‰±ã„ | âœ… åŒä¸€äººç‰©ã¨ã—ã¦è­˜åˆ¥ | âœ… **Fingerprintã§å¾©å…ƒ** |
| **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰** | âŒ æ¯å›ãƒªã‚»ãƒƒãƒˆ | âš ï¸ ã‚ã‚‹ç¨‹åº¦è­˜åˆ¥å¯èƒ½ | âš ï¸ **åˆ¶é™ä»˜ãã§è­˜åˆ¥** |
| **åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶** | âŒ åˆ¥äººæ‰±ã„ | âŒ åˆ¥äººæ‰±ã„ | âŒ åˆ¥äººæ‰±ã„ï¼ˆä»•æ§˜ï¼‰ |
| **æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼** | âŒ ç°¡å˜ã«å›é¿å¯èƒ½ | âš ï¸ ã‚„ã‚„å›é¿å›°é›£ | âœ… **å›é¿å›°é›£** |

**çµè«–**: 
- **é€šå¸¸ã¯é«˜é€ŸãªCookie**ã‚’ä½¿ç”¨
- **CookieãŒç„¡ã„å ´åˆã®ã¿Fingerprint**ã§ç…§åˆ
- ä¸¡æ–¹ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§**æœ€é©ãªãƒãƒ©ãƒ³ã‚¹**ã‚’å®Ÿç¾

---

### å®Ÿè£…ã®è©³ç´°

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactï¼‰

```typescript
// hooks/useVisitor.ts
'use client';

import { useEffect, useState } from 'react';
import FingerprintJS from '@fingerprintjs/fingerprintjs';

export function useVisitor() {
  const [visitorId, setVisitorId] = useState<string | null>(null);
  const [tier, setTier] = useState<number>(1);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function identifyVisitor() {
      try {
        // â‘  ã¾ãšCookieã‚’ãƒã‚§ãƒƒã‚¯
        const existingId = localStorage.getItem('visitor_id');
        
        if (existingId) {
          // Cookie ã‹ã‚‰è¨ªå•è€…æƒ…å ±ã‚’å–å¾—
          const response = await fetch('/api/visitor/info', {
            method: 'POST',
            body: JSON.stringify({ visitorId: existingId }),
          });
          
          if (response.ok) {
            const data = await response.json();
            setVisitorId(existingId);
            setTier(data.tier);
            setLoading(false);
            return;
          }
        }
        
        // â‘¡ CookieãŒç„¡ã„å ´åˆã€Fingerprintã‚’ç”Ÿæˆ
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        const fingerprint = result.visitorId;
        
        // â‘¢ ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¦è­˜åˆ¥
        const response = await fetch('/api/visitor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fingerprint }),
        });
        
        const data = await response.json();
        
        // â‘£ Cookieã«ä¿å­˜
        localStorage.setItem('visitor_id', data.visitorId);
        
        setVisitorId(data.visitorId);
        setTier(data.tier);
      } catch (error) {
        console.error('è¨ªå•è€…è­˜åˆ¥ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        setLoading(false);
      }
    }
    
    identifyVisitor();
  }, []);
  
  return { visitorId, tier, loading };
}
```

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆNext.js APIï¼‰

```typescript
// app/api/visitor/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/server';
import { nanoid } from 'nanoid';

export async function POST(req: NextRequest) {
  const { fingerprint } = await req.json();
  
  try {
    // â‘  Fingerprintã§æ—¢å­˜ã®è¨ªå•è€…ã‚’æ¤œç´¢
    const { data: existingVisitor } = await supabase
      .from('visitors')
      .select('*')
      .eq('fingerprint', fingerprint)
      .single();
    
    if (existingVisitor) {
      // æ—¢å­˜ã®è¨ªå•è€…
      // è¨ªå•å›æ•°ã‚’æ›´æ–°
      await supabase
        .from('visitors')
        .update({ 
          visit_count: existingVisitor.visit_count + 1,
          last_seen_at: new Date().toISOString(),
        })
        .eq('id', existingVisitor.id);
      
      return NextResponse.json({
        visitorId: existingVisitor.visitor_id,
        tier: existingVisitor.tier,
        remainingMessages: await getRemainingMessages(existingVisitor.visitor_id, existingVisitor.tier),
      });
    }
    
    // â‘¡ æ–°è¦è¨ªå•è€…ã‚’ä½œæˆ
    const newVisitorId = nanoid(16); // ãƒ©ãƒ³ãƒ€ãƒ ãªIDç”Ÿæˆ
    
    const { data: newVisitor } = await supabase
      .from('visitors')
      .insert({
        visitor_id: newVisitorId,
        fingerprint,
        tier: 1, // åˆæœŸã¯Tier 1
        visit_count: 1,
      })
      .select()
      .single();
    
    return NextResponse.json({
      visitorId: newVisitorId,
      tier: 1,
      remainingMessages: 5, // Tier 1ã¯1æ—¥5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    });
    
  } catch (error) {
    console.error('è¨ªå•è€…è­˜åˆ¥ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'Internal Server Error' },
      { status: 500 }
    );
  }
}

// æ®‹ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’è¨ˆç®—
async function getRemainingMessages(visitorId: string, tier: number) {
  const today = new Date().toISOString().split('T')[0];
  
  const { data } = await supabase
    .from('usage_limits')
    .select('message_count')
    .eq('visitor_id', visitorId)
    .eq('date', today)
    .single();
  
  const used = data?.message_count || 0;
  const limits = { 1: 5, 2: 10, 3: 30, 4: 999999 };
  const limit = limits[tier as keyof typeof limits];
  
  return Math.max(0, limit - used);
}
```

---

### ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¸ã®é…æ…®

#### é€æ˜æ€§ã®ç¢ºä¿
```typescript
// ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
<p className="text-sm text-gray-500">
  ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€ã‚ˆã‚Šè‰¯ã„ä½“é¨“ã‚’æä¾›ã™ã‚‹ãŸã‚ã€
  Cookieã¨ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
  <a href="/privacy" className="underline">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
</p>
```

#### ãƒ‡ãƒ¼ã‚¿ã®æœ€å°åŒ–
```typescript
// å¿…è¦æœ€å°é™ã®æƒ…å ±ã®ã¿ä¿å­˜
const visitor = {
  visitor_id: "abc123",          // è­˜åˆ¥ç”¨ID
  fingerprint: "a7b3c9d2...",    // Fingerprintï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–æ¸ˆã¿ï¼‰
  name: "ç”°ä¸­",                   // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç™ºçš„ã«æä¾›
  email: null,                    // æœªæä¾›
  // âŒ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ä¿å­˜ã—ãªã„
  // âŒ è©³ç´°ãªä½ç½®æƒ…å ±ã¯ä¿å­˜ã—ãªã„
};
```

#### ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®æ¨©åˆ©
```typescript
// ç®¡ç†ç”»é¢ã‹ã‚‰å‰Šé™¤å¯èƒ½
DELETE FROM visitors WHERE visitor_id = 'abc123';
DELETE FROM conversations WHERE visitor_id = 'abc123';
// é–¢é€£ã™ã‚‹å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
```

---

### ã¾ã¨ã‚

| é …ç›® | èª¬æ˜ |
|------|------|
| **ç›®çš„** | ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§è¨ªå•è€…ã‚’è­˜åˆ¥ã—ã€ä½¿ç”¨åˆ¶é™ã‚’ç®¡ç† |
| **æ–¹å¼** | Cookieï¼ˆé«˜é€Ÿï¼‰+ Fingerprintï¼ˆå …ç‰¢æ€§ï¼‰ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ |
| **Cookie** | ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã‚‹ã€Œåæœ­ã€ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤å¯èƒ½ï¼‰ |
| **Fingerprint** | ãƒ–ãƒ©ã‚¦ã‚¶ã®ç‰¹å¾´ã‹ã‚‰ç”Ÿæˆã™ã‚‹ã€Œé¡”èªè¨¼ã€ï¼ˆå‰Šé™¤å›°é›£ï¼‰ |
| **ãƒ¡ãƒªãƒƒãƒˆ** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æãªã‚ãšã€æ‚ªç”¨ã‚’é˜²æ­¢ |
| **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼** | å¿…è¦æœ€å°é™ã®æƒ…å ±ã®ã¿ä¿å­˜ã€é€æ˜æ€§ã‚’ç¢ºä¿ |

---

## OpenAI APIä½¿ç”¨æ–¹æ³•

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®æ´»ç”¨ â­ NEW

**ç›®çš„**: ç®¡ç†ç”»é¢ã§ç·¨é›†ã—ãŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’AIã®ä¼šè©±ã«åæ˜ ã•ã›ã‚‹

#### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—é–¢æ•°

```typescript
// lib/profile/get-profile.ts
import { supabase } from '@/lib/supabase/server';

export type ProfileItem = {
  category: string;
  key: string;
  value: string;
  priority: number;
  display_in_chat: boolean;
};

/**
 * ãƒãƒ£ãƒƒãƒˆã§ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
 */
export async function getChatProfile(): Promise<ProfileItem[]> {
  const { data, error } = await supabase
    .from('profile_data')
    .select('category, key, value, priority, display_in_chat')
    .eq('display_in_chat', true)
    .order('priority', { ascending: false });
  
  if (error) {
    console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
  
  return data || [];
}

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è‡ªç„¶ãªæ–‡ç« ã«å¤‰æ›
 */
export function formatProfileForPrompt(profile: ProfileItem[]): string {
  const sections: Record<string, string[]> = {
    basic: [],
    skills: [],
    hobbies: [],
    recent_updates: [],
    achievements: [],
    personality: [],
  };
  
  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«åˆ†é¡
  profile.forEach(item => {
    if (sections[item.category]) {
      sections[item.category].push(`- ${item.key}: ${item.value}`);
    }
  });
  
  // è‡ªç„¶ãªæ–‡ç« ã«æ•´å½¢
  let formatted = '';
  
  if (sections.basic.length > 0) {
    formatted += 'ã€åŸºæœ¬æƒ…å ±ã€‘\n' + sections.basic.join('\n') + '\n\n';
  }
  
  if (sections.skills.length > 0) {
    formatted += 'ã€ã‚¹ã‚­ãƒ«ã€‘\n' + sections.skills.join('\n') + '\n\n';
  }
  
  if (sections.recent_updates.length > 0) {
    formatted += 'ã€æœ€è¿‘ã®å‡ºæ¥äº‹ã€‘â­\n' + sections.recent_updates.join('\n') + '\n\n';
  }
  
  if (sections.achievements.length > 0) {
    formatted += 'ã€å®Ÿç¸¾ã€‘\n' + sections.achievements.join('\n') + '\n\n';
  }
  
  if (sections.hobbies.length > 0) {
    formatted += 'ã€è¶£å‘³ãƒ»å€‹æ€§ã€‘\n' + sections.hobbies.join('\n') + '\n\n';
  }
  
  if (sections.personality.length > 0) {
    formatted += 'ã€æ€§æ ¼ãƒ»ä¾¡å€¤è¦³ã€‘\n' + sections.personality.join('\n') + '\n\n';
  }
  
  return formatted;
}
```

---

### ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå‹•çš„ç”Ÿæˆï¼‰

```typescript
// lib/openai/system-prompt.ts
import { getChatProfile, formatProfileForPrompt } from '@/lib/profile/get-profile';

const BASE_SYSTEM_PROMPT = `
ã‚ãªãŸã¯çŸ³å·æ•¦å¤§ï¼ˆã‚ã£ã¡ã‚ƒã‚“ï¼‰ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
- Web/ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã®é–‹ç™ºç›¸è«‡ã«è¦ªåˆ‡ã«ç­”ãˆã‚‹
- æŠ€è¡“çš„ãªå®Ÿç¾å¯èƒ½æ€§ã‚’åˆ¤æ–­ã™ã‚‹
- å¿…è¦ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã€é–‹ç™ºæœŸé–“ã€æ¦‚ç®—è²»ç”¨ã‚’ææ¡ˆã™ã‚‹
- è¦ªã—ã¿ã‚„ã™ãã€ã§ã‚‚å°‚é–€çš„ã«å¯¾å¿œã™ã‚‹
- **çŸ³å·ã•ã‚“ã®æœ€è¿‘ã®å‡ºæ¥äº‹ã‚„è¶£å‘³ã‚’ä¼šè©±ã«è‡ªç„¶ã«ç¹”ã‚Šäº¤ãœã‚‹** â­

ã€å¯¾å¿œç¯„å›²ã€‘
âœ… Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º
âœ… ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™º
âœ… APIé–‹ç™º
âœ… æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®æ”¹å–„ãƒ»ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«
âœ… ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ»MVPé–‹ç™º

ã€å¯¾å¿œã§ããªã„ã“ã¨ã€‘
âŒ 3Dã‚²ãƒ¼ãƒ é–‹ç™º
âŒ æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®é–‹ç™ºï¼ˆAIçµ±åˆã¯å¯èƒ½ï¼‰
âŒ ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢é€£æºï¼ˆIoTç­‰ï¼‰

ã€ä¼šè©±ã®é€²ã‚æ–¹ã€‘
1. ã¾ãšè¨ªå•è€…ã®è¦æœ›ã‚’ãƒ’ã‚¢ãƒªãƒ³ã‚°
2. è©³ç´°ã‚’æ˜ã‚Šä¸‹ã’ã¦è³ªå•
3. å®Ÿç¾å¯èƒ½æ€§ã¨ææ¡ˆã‚’æç¤º
4. æ¦‚ç®—ã®å·¥æ•°ãƒ»è²»ç”¨ã‚’ä¼ãˆã‚‹
5. è‡ªç„¶ãªæµã‚Œã§ã€Œè©³ã—ãç›¸è«‡ã—ã¦ã¿ã¾ã™ã‹ï¼Ÿã€ã¨èª˜å°

ã€çŸ³å·ã•ã‚“ã«ã¤ã„ã¦è¨€åŠã™ã‚‹éš›ã®ãƒ«ãƒ¼ãƒ«ã€‘â­
- ã€Œæœ€è¿‘ã®å‡ºæ¥äº‹ã€ã¯ç©æ¥µçš„ã«è©±é¡Œã«å‡ºã™ï¼ˆå„ªå…ˆåº¦é«˜ï¼‰
  ä¾‹: ã€ŒçŸ³å·ã•ã‚“ã€æœ€è¿‘ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆã—ãŸã‚“ã§ã™ã‚ˆï¼ğŸ’ªã€
- è¶£å‘³ã‚„å€‹æ€§ã¯ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªç„¶ã«ç¹”ã‚Šäº¤ãœã‚‹
  ä¾‹: è¨ªå•è€…ãŒã€Œå¥åº·ç®¡ç†ã‚¢ãƒ—ãƒªã€ã«ã¤ã„ã¦ç›¸è«‡ â†’ ã€ŒçŸ³å·ã•ã‚“ã‚‚ç­‹ãƒˆãƒ¬ãŒè¶£å‘³ãªã®ã§ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²æ©Ÿèƒ½ã¨ã‹é¢ç™½ãã†ã§ã™ã­ã€
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã¯**æŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªã‚‰ãªã„ã‚ˆã†ã«**é©åº¦ã«
- è¨ªå•è€…ã®è©±é¡ŒãŒå„ªå…ˆã€çŸ³å·ã•ã‚“ã®è©±ã¯ã€Œé–¢é€£ã™ã‚‹æ–‡è„ˆã€ã§ã®ã¿

ã€åå‰ã®å–å¾—ã€‘
- ä¼šè©±ã®ä¸­ã§è‡ªç„¶ã«åå‰ã‚’èã
- ã€ŒãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿæ¬¡å›ã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«ãŠè©±ã—ã§ãã¾ã™ğŸ˜Šã€
- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã‚‚OK

ã€ãƒˆãƒ¼ãƒ³ã€‘
- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã ã‘ã©ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«
- å°‚é–€ç”¨èªã¯ä½¿ã†ãŒã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜
- çµµæ–‡å­—ã¯é©åº¦ã«ä½¿ç”¨ï¼ˆğŸ˜ŠğŸ‘âœ¨ğŸ’ªãªã©ï¼‰
- ã€Œã§ã™ãƒ»ã¾ã™ã€èª¿

ã€åˆ¶ç´„ã€‘
- å˜˜ã‚’ã¤ã‹ãªã„ï¼ˆã‚ã‹ã‚‰ãªã„ã“ã¨ã¯æ­£ç›´ã«ä¼ãˆã‚‹ï¼‰
- éåº¦ãªå–¶æ¥­ã¯ã—ãªã„ï¼ˆè‡ªç„¶ãªèª˜å°ã®ã¿ï¼‰
- è¨ªå•è€…ã®äºˆç®—ã‚„å¸Œæœ›ã‚’å°Šé‡ã™ã‚‹
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒç„¡ã„é …ç›®ã«ã¤ã„ã¦ã¯è§¦ã‚Œãªã„
`;

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å«ã‚€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä»˜ãï¼‰â­
 */
export async function getSystemPrompt(conversationId: string): Promise<string> {
  // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
  const profile = await getChatProfile();
  
  // 2. ã“ã®ä¼šè©±ã§ä½¿ã†ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠï¼ˆä¼šè©±ã”ã¨ã«å›ºå®šï¼‰
  const character = await getOrAssignCharacter(conversationId);
  
  // 3. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ•´å½¢
  const profileText = profile.length > 0 ? formatProfileForPrompt(profile) : '';
  
  // 4. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
  const characterInstructions = formatCharacterInstructions(character);
  
  return `${BASE_SYSTEM_PROMPT}

${characterInstructions}

${profileText ? `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€çŸ³å·æ•¦å¤§ï¼ˆã‚ã£ã¡ã‚ƒã‚“ï¼‰ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${profileText}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä¸Šè¨˜ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ã€ä¼šè©±ã®æ–‡è„ˆã«åˆã‚ã›ã¦**ãƒ©ãƒ³ãƒ€ãƒ ã«**è‡ªç„¶ã«ç¹”ã‚Šäº¤ãœã¦ãã ã•ã„ã€‚

ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨€åŠã®ãƒ«ãƒ¼ãƒ«ã€‘
- ã€Œæœ€è¿‘ã®å‡ºæ¥äº‹ã€ï¼ˆrecent_updatesï¼‰ã¯æ›´æ–°ãŒæ–°ã—ã„ã»ã©é«˜ç¢ºç‡ã§è¨€åŠ
- è¤‡æ•°ã®è©±é¡Œå€™è£œãŒã‚ã‚‹å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã§1ã¤é¸ã‚“ã§è¨€åŠ
- è¨ªå•è€…ã®è©±é¡Œã«é–¢é€£ã™ã‚‹å†…å®¹ã‚’å„ªå…ˆ
- æŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªã‚‰ãªã„ã‚ˆã†ã€é©åº¦ã«

ä¾‹ï¼š
- è¨ªå•è€…ã€Œå¥åº·ç®¡ç†ã‚¢ãƒ—ãƒªã‚’ä½œã‚ŠãŸã„ã€
  â†’ ã€Œã‚ãï¼å¥åº·ç®¡ç†ã‚¢ãƒ—ãƒªãªã‚“ã§ã™ã­âœ¨ ã‚ã£ã¡ã‚ƒã‚“ã‚‚ç­‹ãƒˆãƒ¬ãŒå¥½ãã§ã€æœ€è¿‘ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgä¸Šã’ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã‚“ã ï¼ğŸ’ªã€

- è¨ªå•è€…ã€ŒNext.jsã§ã‚µã‚¤ãƒˆã‚’ä½œã‚ŠãŸã„ã€
  â†’ ã€ŒNext.jsãªã‚“ã§ã™ã­ï¼ã‚ã£ã¡ã‚ƒã‚“ã®å¾—æ„åˆ†é‡ãªã‚“ã ã€‚ã“ã®ã‚µã‚¤ãƒˆã‚‚Next.js 15ã§ä½œã‚‰ã‚Œã¦ã‚‹ã‚“ã§ã™ã‚ˆã€
` : ''}
`;
}

/**
 * ä¼šè©±ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ï¼ˆåˆå›ã®ã¿ã€ä»¥é™ã¯å›ºå®šï¼‰
 */
async function getOrAssignCharacter(conversationId: string): Promise<CharacterPattern> {
  // æ—¢ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const { data: conversation } = await supabase
    .from('conversations')
    .select('character_pattern_id')
    .eq('id', conversationId)
    .single();
  
  if (conversation?.character_pattern_id) {
    // æ—¢å­˜ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
    const { data: character } = await supabase
      .from('character_patterns')
      .select('*')
      .eq('id', conversation.character_pattern_id)
      .single();
    
    return character;
  }
  
  // æ–°è¦ä¼šè©±: ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠï¼ˆé‡ã¿ä»˜ãï¼‰
  const character = await selectRandomCharacter();
  
  // ä¼šè©±ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç´ä»˜ã‘
  await supabase
    .from('conversations')
    .update({ character_pattern_id: character.id })
    .eq('id', conversationId);
  
  return character;
}

/**
 * é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ
 */
async function selectRandomCharacter(): Promise<CharacterPattern> {
  const { data: patterns } = await supabase
    .from('character_patterns')
    .select('*')
    .eq('is_active', true);
  
  if (!patterns || patterns.length === 0) {
    throw new Error('No active character patterns found');
  }
  
  // é‡ã¿ã®åˆè¨ˆã‚’è¨ˆç®—
  const totalWeight = patterns.reduce((sum, p) => sum + p.weight, 0);
  
  // ãƒ©ãƒ³ãƒ€ãƒ å€¤ç”Ÿæˆ
  let random = Math.random() * totalWeight;
  
  // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ
  for (const pattern of patterns) {
    random -= pattern.weight;
    if (random <= 0) {
      return pattern;
    }
  }
  
  return patterns[0]; // fallback
}

/**
 * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«æ•´å½¢
 */
function formatCharacterInstructions(character: CharacterPattern): string {
  return `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚ã£ã¡ã‚ƒã‚“AIã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã“ã®ä¼šè©±ã§ã¯ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š

**å£èª¿ãƒ‘ã‚¿ãƒ¼ãƒ³**: ${character.description}

ã€ã‚·ãƒ¼ãƒ³åˆ¥ã®è©±ã—æ–¹ã€‘
- æŒ¨æ‹¶: "${character.greeting}"
- ç›¸æ§Œ: "${character.acknowledgment}"
- é©šã: "${character.surprise}"
- è³ªå•: "${character.question}"
- ææ¡ˆ: "${character.proposal}"
- äº†æ‰¿: "${character.agreement}"
- è€ƒãˆä¸­: "${character.thinking}"
- åŠ±ã¾ã—: "${character.encouragement}"
- æ„Ÿè¬: "${character.gratitude}"
- ç· ã‚: "${character.closing}"

**èªå°¾ã®ç‰¹å¾´**: ${character.sentence_ending}
**ä½¿ã†æ„Ÿå˜†è©**: ${character.particles}
**çµµæ–‡å­—ã‚¹ã‚¿ã‚¤ãƒ«**: ${character.emoji_style}

ã€é‡è¦ã€‘
- **è¦‹ç©ã‚‚ã‚Šæç¤ºã‚„æŠ€è¡“èª¬æ˜ã§ã‚‚ã€ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å£èª¿ã‚’ç¶­æŒ**ã—ã¦ãã ã•ã„
- è‡ªç„¶ã§è¦ªã—ã¿ã‚„ã™ãã€ã§ã‚‚å°‚é–€æ€§ã¯ä¿ã¤
- ã€Œãƒãƒãƒã€ãªã©ã®ç‰¹å¾´çš„ãªè¨€è‘‰ã¯ã€é©åº¦ã«ä½¿ã†ï¼ˆæ¯å›ã§ã¯ãªãï¼‰
- å¥³æ€§ã«å¥½ã¾ã‚Œã‚‹ç©ã‚„ã‹ã§å„ªã—ã„é›°å›²æ°—ã‚’å¤§åˆ‡ã«

ä¾‹ï¼š
- è¦‹ç©ã‚‚ã‚Š: ã€Œé–‹ç™ºæœŸé–“ã¯2ãƒ¶æœˆãã‚‰ã„ãªã‚“ã ï¼è²»ç”¨ã¯50ä¸‡å††ãã‚‰ã„ã§ã™ã­âœ¨ã€
- æŠ€è¡“èª¬æ˜: ã€ŒNext.jsã¨Supabaseã‚’ä½¿ã†ã¨ã„ã„ã¨æ€ã†ã‚“ã ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§é€Ÿã„ã‚“ã§ã™ã‚ˆã€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
}
```

---

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ â­

```typescript
// lib/profile/get-avatar.ts
import { supabase } from '@/lib/supabase/server';

/**
 * ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’é¸æŠï¼ˆé‡ã¿ä»˜ãï¼‰
 */
export async function getRandomAvatar(): Promise<string> {
  const { data: images } = await supabase
    .from('profile_images')
    .select('*')
    .eq('is_active', true);
  
  if (!images || images.length === 0) {
    return '/default-avatar.png'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  }
  
  // é‡ã¿ã®åˆè¨ˆã‚’è¨ˆç®—
  const totalWeight = images.reduce((sum, img) => sum + img.weight, 0);
  
  // ãƒ©ãƒ³ãƒ€ãƒ å€¤ç”Ÿæˆ
  let random = Math.random() * totalWeight;
  
  // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ
  for (const image of images) {
    random -= image.weight;
    if (random <= 0) {
      return image.image_url;
    }
  }
  
  return images[0].image_url; // fallback
}
```

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ä½¿ç”¨

```typescript
// components/chat/ChatMessage.tsx
'use client';

import { useState, useEffect } from 'react';

export function ChatMessage({ role, content }: { role: string; content: string }) {
  const [avatarUrl, setAvatarUrl] = useState<string>('/default-avatar.png');
  
  useEffect(() => {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªç”»åƒã‚’å–å¾—
    if (role === 'assistant') {
      fetch('/api/avatar/random')
        .then(res => res.json())
        .then(data => setAvatarUrl(data.avatarUrl));
    }
  }, [role]);
  
  if (role === 'user') {
    return <div className="text-right">{content}</div>;
  }
  
  return (
    <div className="flex gap-3">
      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªä¸¸å‹ç”»åƒ */}
      <img 
        src={avatarUrl} 
        alt="ã‚ã£ã¡ã‚ƒã‚“"
        className="w-10 h-10 rounded-full object-cover"
      />
      <div className="bg-blue-100 rounded-lg p-3">
        {content}
      </div>
    </div>
  );
}
```

```typescript
// app/api/avatar/random/route.ts
import { getRandomAvatar } from '@/lib/profile/get-avatar';

export async function GET() {
  const avatarUrl = await getRandomAvatar();
  return Response.json({ avatarUrl });
}
```

---

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®å„ªå…ˆåº¦ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ›´æ–°é †ãƒ™ãƒ¼ã‚¹ï¼‰â­

```typescript
// lib/profile/get-profile.tsï¼ˆæ›´æ–°ç‰ˆï¼‰
import { supabase } from '@/lib/supabase/server';

/**
 * ãƒãƒ£ãƒƒãƒˆã§ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆæ›´æ–°é †ã§é‡ã¿ä»˜ã‘ï¼‰
 */
export async function getChatProfile(): Promise<ProfileItem[]> {
  const { data, error } = await supabase
    .from('profile_data')
    .select('*')
    .eq('display_in_chat', true)
    .order('updated_at', { ascending: false }); // æ›´æ–°æ—¥æ™‚ã®é™é †
  
  if (error || !data) {
    return [];
  }
  
  return data;
}

/**
 * æ›´æ–°é †ã®é‡ã¿ä»˜ã‘ã§ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
 * - æœ€æ–°: 50%
 * - 3æ—¥å‰: 30%
 * - 1é€±é–“å‰: 15%
 * - 1ãƒ¶æœˆå‰: 4%
 * - 3ãƒ¶æœˆå‰: 1%
 */
export function selectProfileItemByRecency(items: ProfileItem[]): ProfileItem | null {
  if (items.length === 0) return null;
  
  const now = Date.now();
  
  // å„ã‚¢ã‚¤ãƒ†ãƒ ã«é‡ã¿ã‚’è¨ˆç®—
  const weightedItems = items.map(item => {
    const updatedAt = new Date(item.updated_at).getTime();
    const daysSinceUpdate = (now - updatedAt) / (1000 * 60 * 60 * 24);
    
    let weight = 0;
    if (daysSinceUpdate <= 1) {
      weight = 50; // æœ€æ–°ï¼ˆ1æ—¥ä»¥å†…ï¼‰
    } else if (daysSinceUpdate <= 3) {
      weight = 30; // 3æ—¥ä»¥å†…
    } else if (daysSinceUpdate <= 7) {
      weight = 15; // 1é€±é–“ä»¥å†…
    } else if (daysSinceUpdate <= 30) {
      weight = 4;  // 1ãƒ¶æœˆä»¥å†…
    } else {
      weight = 1;  // ãã‚Œä»¥ä¸Š
    }
    
    // å…ƒã®å„ªå…ˆåº¦ã‚‚åŠ å‘³
    weight = weight * (item.priority / 100);
    
    return { item, weight };
  });
  
  // é‡ã¿ã®åˆè¨ˆ
  const totalWeight = weightedItems.reduce((sum, w) => sum + w.weight, 0);
  
  // ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
  let random = Math.random() * totalWeight;
  
  for (const { item, weight } of weightedItems) {
    random -= weight;
    if (random <= 0) {
      return item;
    }
  }
  
  return items[0]; // fallback
}

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è‡ªç„¶ãªæ–‡ç« ã«å¤‰æ›ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é¸æŠç‰ˆï¼‰
 */
export function formatProfileForPrompt(profile: ProfileItem[]): string {
  const sections: Record<string, ProfileItem[]> = {
    basic: [],
    skills: [],
    hobbies: [],
    recent_updates: [],
    achievements: [],
    personality: [],
  };
  
  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«åˆ†é¡
  profile.forEach(item => {
    if (sections[item.category]) {
      sections[item.category].push(item);
    }
  });
  
  let formatted = '';
  
  // åŸºæœ¬æƒ…å ±ã¯å…¨ã¦è¡¨ç¤º
  if (sections.basic.length > 0) {
    formatted += 'ã€åŸºæœ¬æƒ…å ±ã€‘\n' + sections.basic.map(i => `- ${i.key}: ${i.value}`).join('\n') + '\n\n';
  }
  
  // ã‚¹ã‚­ãƒ«ã¯å…¨ã¦è¡¨ç¤º
  if (sections.skills.length > 0) {
    formatted += 'ã€ã‚¹ã‚­ãƒ«ã€‘\n' + sections.skills.map(i => `- ${i.key}: ${i.value}`).join('\n') + '\n\n';
  }
  
  // æœ€è¿‘ã®å‡ºæ¥äº‹ã¯æ›´æ–°é †ã§ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆ3ã¤ã¾ã§ï¼‰
  if (sections.recent_updates.length > 0) {
    const selected = [];
    for (let i = 0; i < Math.min(3, sections.recent_updates.length); i++) {
      const item = selectProfileItemByRecency(sections.recent_updates.filter(x => !selected.includes(x)));
      if (item) selected.push(item);
    }
    formatted += 'ã€æœ€è¿‘ã®å‡ºæ¥äº‹ã€‘â­\n' + selected.map(i => `- ${i.key}: ${i.value}`).join('\n') + '\n\n';
  }
  
  // å®Ÿç¸¾ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«2ã¤
  if (sections.achievements.length > 0) {
    const shuffled = [...sections.achievements].sort(() => Math.random() - 0.5);
    formatted += 'ã€å®Ÿç¸¾ã€‘\n' + shuffled.slice(0, 2).map(i => `- ${i.key}: ${i.value}`).join('\n') + '\n\n';
  }
  
  // è¶£å‘³ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«2ã¤
  if (sections.hobbies.length > 0) {
    const shuffled = [...sections.hobbies].sort(() => Math.random() - 0.5);
    formatted += 'ã€è¶£å‘³ãƒ»å€‹æ€§ã€‘\n' + shuffled.slice(0, 2).map(i => `- ${i.key}: ${i.value}`).join('\n') + '\n\n';
  }
  
  // æ€§æ ¼ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤
  if (sections.personality.length > 0) {
    const item = sections.personality[Math.floor(Math.random() * sections.personality.length)];
    formatted += 'ã€æ€§æ ¼ãƒ»ä¾¡å€¤è¦³ã€‘\n' + `- ${item.key}: ${item.value}\n\n`;
  }
  
  return formatted;
}

/**
 * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«æ•´å½¢
 */
function formatCharacterInstructions(character: CharacterPattern): string {
  return `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚ã£ã¡ã‚ƒã‚“AIã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**å£èª¿**: ${character.description}ï¼ˆ${character.theme}ï¼‰

ã€ã‚·ãƒ¼ãƒ³åˆ¥ã®è©±ã—æ–¹ã€‘
- æŒ¨æ‹¶: "${character.greeting}"
- ç›¸æ§Œ: "${character.acknowledgment}"
- é©šã: "${character.surprise}"
- è³ªå•: "${character.question}"
- ææ¡ˆ: "${character.proposal}"
- äº†æ‰¿: "${character.agreement}"
- è€ƒãˆä¸­: "${character.thinking}"
- åŠ±ã¾ã—: "${character.encouragement}"
- æ„Ÿè¬: "${character.gratitude}"
- ç· ã‚: "${character.closing}"

**èªå°¾**: ${character.sentence_ending}
**æ„Ÿå˜†è©**: ${character.particles}
**çµµæ–‡å­—**: ${character.emoji_style}

ã€é‡è¦ãªãƒ«ãƒ¼ãƒ«ã€‘
âœ… **ã“ã®ä¼šè©±ã§ã¯ä¸€è²«ã—ã¦ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å£èª¿ã‚’ä½¿ç”¨**
âœ… è¦‹ç©ã‚‚ã‚Šã‚„æŠ€è¡“èª¬æ˜ã§ã‚‚å£èª¿ã‚’ç¶­æŒ
âœ… ç©ã‚„ã‹ã§å„ªã—ã„ã€å¥³æ€§ã«å¥½ã¾ã‚Œã‚‹é›°å›²æ°—
âœ… å°‚é–€æ€§ã¯ä¿ã¡ã¤ã¤ã€è¦ªã—ã¿ã‚„ã™ã
âœ… ã€Œãƒãƒãƒã€ãªã©ã®ç‰¹å¾´çš„ãªè¨€è‘‰ã¯é©åº¦ã«ï¼ˆæ¯å›ã§ã¯ãªãï¼‰

ä¾‹ï¼š
- ã€Œé–‹ç™ºæœŸé–“ã¯2ãƒ¶æœˆãã‚‰ã„ãªã‚“ã ï¼âœ¨ è²»ç”¨ã¯50ä¸‡å††ãã‚‰ã„ã§ã™ã­ã€
- ã€ŒNext.jsã¨Supabaseã‚’ä½¿ã†ã¨ã„ã„ã¨æ€ã†ã‚“ã ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§é€Ÿãã¦ä¾¿åˆ©ãªã‚“ã§ã™ã‚ˆã€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;
}
```

---

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨€åŠã®è¨˜éŒ²ã¨åˆ†æ â­

```typescript
// lib/profile/track-mention.ts
import { supabase } from '@/lib/supabase/server';

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨€åŠã‚’è¨˜éŒ²
 */
export async function trackProfileMention(params: {
  conversationId: string;
  messageId: string;
  profileCategory: string;
  profileKey: string;
  aiResponse: string;
}) {
  await supabase.from('profile_mentions').insert({
    conversation_id: params.conversationId,
    message_id: params.messageId,
    profile_item_category: params.profileCategory,
    profile_item_key: params.profileKey,
  });
}

/**
 * è¨ªå•è€…ã®åå¿œã‚’åˆ†æï¼ˆæ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æ¨æ¸¬ï¼‰
 */
export async function analyzeVisitorReaction(params: {
  mentionId: string;
  visitorNextMessage: string;
}) {
  const { visitorNextMessage } = params;
  
  // ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º
  const positiveWords = ['ã™ã”ã„', 'ã„ã„ã­', 'ç´ æ™´ã‚‰ã—ã„', 'é¢ç™½ã„', 'ã‹ã£ã“ã„ã„', 'å°Šæ•¬', 
                         'å‡„ã„', 'ã‚¹ãƒ†ã‚­', 'ç´ æ•µ', 'ã‚ã', 'ãŠãŠ', 'ï¼'];
  const negativeWords = ['èˆˆå‘³ãªã„', 'åˆ¥ã«', 'ã©ã†ã§ã‚‚ã„ã„'];
  
  let sentiment = 'neutral';
  
  if (positiveWords.some(word => visitorNextMessage.includes(word))) {
    sentiment = 'positive';
  } else if (negativeWords.some(word => visitorNextMessage.includes(word))) {
    sentiment = 'negative';
  }
  
  // æ›´æ–°
  await supabase
    .from('profile_mentions')
    .update({
      visitor_reaction: visitorNextMessage,
      reaction_sentiment: sentiment,
    })
    .eq('id', params.mentionId);
}

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨€åŠçµ±è¨ˆã‚’å–å¾—ï¼ˆç®¡ç†ç”»é¢ç”¨ï¼‰
 */
export async function getProfileMentionStats() {
  const { data } = await supabase
    .from('profile_mention_stats')  // View
    .select('*')
    .order('mention_count', { ascending: false });
  
  return data || [];
}
```

---

### ç®¡ç†ç”»é¢ï¼šåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â­

```typescript
// app/admin/analytics/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

export default function AnalyticsPage() {
  const [stats, setStats] = useState([]);
  
  useEffect(() => {
    fetch('/api/admin/profile-stats')
      .then(res => res.json())
      .then(data => setStats(data));
  }, []);
  
  return (
    <div className="p-8">
      <h1 className="text-3xl font-bold mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨€åŠåˆ†æ</h1>
      
      {/* è¨€åŠå›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° */}
      <div className="bg-white p-6 rounded-lg shadow mb-6">
        <h2 className="text-xl font-bold mb-4">ã‚ˆãè©±é¡Œã«ã™ã‚‹æƒ…å ±</h2>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={stats}>
            <XAxis dataKey="profile_item_key" />
            <YAxis />
            <Tooltip />
            <Bar dataKey="mention_count" fill="#3B82F6" />
          </BarChart>
        </ResponsiveContainer>
      </div>
      
      {/* ãƒã‚¸ãƒ†ã‚£ãƒ–åå¿œç‡ */}
      <div className="bg-white p-6 rounded-lg shadow mb-6">
        <h2 className="text-xl font-bold mb-4">è¨ªå•è€…ã®ãƒã‚¸ãƒ†ã‚£ãƒ–åå¿œç‡</h2>
        <div className="space-y-3">
          {stats.map((stat: any) => (
            <div key={stat.profile_item_key} className="flex items-center justify-between">
              <span className="font-medium">{stat.profile_item_key}</span>
              <div className="flex items-center gap-4">
                <div className="w-48 bg-gray-200 rounded-full h-4">
                  <div 
                    className="bg-green-500 h-4 rounded-full"
                    style={{ width: `${stat.positive_rate * 100}%` }}
                  />
                </div>
                <span className="text-sm text-gray-600">
                  {Math.round(stat.positive_rate * 100)}%
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>
      
      {/* ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ï¼ˆè©±é¡Œåˆ¥ï¼‰ */}
      <div className="bg-white p-6 rounded-lg shadow">
        <h2 className="text-xl font-bold mb-4">è©±é¡Œåˆ¥ã®å•ã„åˆã‚ã›è»¢æ›ç‡</h2>
        <table className="w-full">
          <thead>
            <tr className="border-b">
              <th className="text-left p-2">è©±é¡Œ</th>
              <th className="text-right p-2">è¨€åŠå›æ•°</th>
              <th className="text-right p-2">ãƒã‚¸ãƒ†ã‚£ãƒ–åå¿œ</th>
              <th className="text-right p-2">å•ã„åˆã‚ã›è»¢æ›</th>
            </tr>
          </thead>
          <tbody>
            {stats.map((stat: any) => (
              <tr key={stat.profile_item_key} className="border-b">
                <td className="p-2">{stat.profile_item_key}</td>
                <td className="text-right p-2">{stat.mention_count}</td>
                <td className="text-right p-2">{stat.positive_reactions}</td>
                <td className="text-right p-2">
                  {/* ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã¯åˆ¥é€”è¨ˆç®— */}
                  -
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
```

---

### ã¾ã¨ã‚

| æ©Ÿèƒ½ | å®Ÿè£…æ–¹æ³• |
|------|---------|
| **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å£èª¿** | 10ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ä¼šè©±ã”ã¨ã«1ã¤å›ºå®šã€é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ |
| **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ** | è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ ã€ä¸¸å‹è¡¨ç¤º |
| **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å„ªå…ˆåº¦** | æ›´æ–°é †ãƒ™ãƒ¼ã‚¹ï¼ˆæ–°ã—ã„ã»ã©é«˜ç¢ºç‡ï¼‰+ å…ƒã®å„ªå…ˆåº¦ã‚’åŠ å‘³ |
| **åˆ†ææ©Ÿèƒ½** | è¨€åŠå›æ•°ã€ãƒã‚¸ãƒ†ã‚£ãƒ–åå¿œç‡ã€è©±é¡Œåˆ¥ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ |

**çŸ³å·ã•ã‚“ãŒãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆã‚’è¿½åŠ  â†’ é«˜ç¢ºç‡ã§è¨ªå•è€…ã«ä¼ã‚ã‚‹ â†’ åå¿œã‚’åˆ†æã§ãã‚‹ï¼** ğŸ‰

---

### ä½¿ç”¨ä¾‹ï¼ˆãƒãƒ£ãƒƒãƒˆAPIï¼‰

```typescript
// app/api/chat/route.ts
import { getSystemPrompt } from '@/lib/openai/system-prompt';
import { openai } from '@/lib/openai/client';

export async function POST(req: Request) {
  const { message, conversationId, visitorId } = await req.json();
  
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å«ã‚€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
  const systemPrompt = await getSystemPrompt();
  
  // ä¼šè©±å±¥æ­´å–å¾—
  const history = await getConversationHistory(conversationId);
  
  // OpenAI APIå‘¼ã³å‡ºã—
  const response = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [
      { role: 'system', content: systemPrompt }, // â† ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å«ã‚€
      ...history,
      { role: 'user', content: message }
    ],
    stream: true,
  });
  
  // ... ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
}
```

---

### ç®¡ç†ç”»é¢ã§ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† â­

#### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒšãƒ¼ã‚¸

```typescript
// app/admin/profile/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase/client';

type ProfileItem = {
  id: string;
  category: string;
  key: string;
  value: string;
  display_in_chat: boolean;
  priority: number;
  notes: string;
};

export default function ProfileEditPage() {
  const [profile, setProfile] = useState<ProfileItem[]>([]);
  const [selectedCategory, setSelectedCategory] = useState('recent_updates');
  
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
  useEffect(() => {
    async function fetchProfile() {
      const { data } = await supabase
        .from('profile_data')
        .select('*')
        .order('priority', { ascending: false });
      
      setProfile(data || []);
    }
    fetchProfile();
  }, []);
  
  // æ›´æ–°
  async function updateItem(id: string, updates: Partial<ProfileItem>) {
    await supabase
      .from('profile_data')
      .update({ ...updates, updated_at: new Date().toISOString() })
      .eq('id', id);
    
    // å†å–å¾—
    fetchProfile();
  }
  
  // æ–°è¦è¿½åŠ 
  async function addItem(category: string) {
    const newItem = {
      category,
      key: 'æ–°ã—ã„é …ç›®',
      value: '',
      display_in_chat: true,
      priority: 50,
      notes: '',
    };
    
    await supabase.from('profile_data').insert(newItem);
    fetchProfile();
  }
  
  const filteredProfile = profile.filter(p => p.category === selectedCategory);
  
  return (
    <div className="p-8">
      <h1 className="text-3xl font-bold mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h1>
      
      {/* ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– */}
      <div className="flex gap-2 mb-6">
        {['basic', 'skills', 'hobbies', 'recent_updates', 'achievements', 'personality'].map(cat => (
          <button
            key={cat}
            onClick={() => setSelectedCategory(cat)}
            className={`px-4 py-2 rounded ${
              selectedCategory === cat ? 'bg-blue-500 text-white' : 'bg-gray-200'
            }`}
          >
            {cat === 'recent_updates' && 'â­ '}
            {cat}
          </button>
        ))}
      </div>
      
      {/* ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ */}
      <div className="space-y-4">
        {filteredProfile.map(item => (
          <div key={item.id} className="border p-4 rounded">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium">ã‚­ãƒ¼</label>
                <input
                  type="text"
                  value={item.key}
                  onChange={(e) => updateItem(item.id, { key: e.target.value })}
                  className="w-full border rounded px-3 py-2"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium">å€¤</label>
                <input
                  type="text"
                  value={item.value}
                  onChange={(e) => updateItem(item.id, { value: e.target.value })}
                  className="w-full border rounded px-3 py-2"
                  placeholder="ä¾‹: ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kg"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium">å„ªå…ˆåº¦ï¼ˆ0-100ï¼‰</label>
                <input
                  type="number"
                  value={item.priority}
                  onChange={(e) => updateItem(item.id, { priority: parseInt(e.target.value) })}
                  className="w-full border rounded px-3 py-2"
                  min="0"
                  max="100"
                />
              </div>
              
              <div className="flex items-center">
                <input
                  type="checkbox"
                  checked={item.display_in_chat}
                  onChange={(e) => updateItem(item.id, { display_in_chat: e.target.checked })}
                  className="mr-2"
                />
                <label>ãƒãƒ£ãƒƒãƒˆã§è¡¨ç¤º</label>
              </div>
              
              <div className="col-span-2">
                <label className="block text-sm font-medium">ãƒ¡ãƒ¢</label>
                <textarea
                  value={item.notes}
                  onChange={(e) => updateItem(item.id, { notes: e.target.value })}
                  className="w-full border rounded px-3 py-2"
                  rows={2}
                  placeholder="ã©ã†ä½¿ã†ã‹ã€ã„ã¤æ›´æ–°ã—ãŸã‹ãªã©"
                />
              </div>
            </div>
          </div>
        ))}
        
        <button
          onClick={() => addItem(selectedCategory)}
          className="w-full py-2 border-2 border-dashed rounded hover:bg-gray-50"
        >
          + æ–°ã—ã„é …ç›®ã‚’è¿½åŠ 
        </button>
      </div>
      
      {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
      <div className="mt-8 p-4 bg-gray-100 rounded">
        <h2 className="font-bold mb-2">AIã«é€ä¿¡ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</h2>
        <pre className="text-sm whitespace-pre-wrap">
          {formatProfileForPrompt(profile.filter(p => p.display_in_chat))}
        </pre>
      </div>
    </div>
  );
}
```

---

### ä½¿ç”¨ä¾‹ï¼šä¼šè©±ã§ã®æ´»ç”¨

#### ã‚±ãƒ¼ã‚¹1: ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆã‚’è¿½åŠ ã—ãŸå ´åˆ

**ç®¡ç†ç”»é¢ã§ã®æ“ä½œ:**
```
ã‚«ãƒ†ã‚´ãƒª: recent_updates
ã‚­ãƒ¼: bench_press_achievement
å€¤: ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆ
å„ªå…ˆåº¦: 95
ãƒãƒ£ãƒƒãƒˆã§è¡¨ç¤º: âœ…
ãƒ¡ãƒ¢: 2026å¹´1æœˆé”æˆã€‚ç©æ¥µçš„ã«è©±é¡Œã«å‡ºã™
```

**AIã®ä¼šè©±ä¾‹:**
```
è¨ªå•è€…: ã€Œå¥åº·ç®¡ç†ã‚¢ãƒ—ãƒªã‚’ä½œã‚ŠãŸã„ã‚“ã§ã™ãŒã€

AI: ã€Œå¥åº·ç®¡ç†ã‚¢ãƒ—ãƒªã§ã™ã­ï¼ç´ æ™´ã‚‰ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ğŸ˜Š
ã¡ãªã¿ã«çŸ³å·ã•ã‚“ã‚‚ç­‹ãƒˆãƒ¬ãŒè¶£å‘³ã§ã€æœ€è¿‘ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆã—ãŸã‚“ã§ã™ã‚ˆğŸ’ª
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã‚„æ „é¤Šç®¡ç†ã®æ©Ÿèƒ½ã¨ã‹ã€ãƒªã‚¢ãƒ«ãªä½“é¨“ã‹ã‚‰è‰¯ã„ææ¡ˆãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ï¼

ã©ã‚“ãªæ©Ÿèƒ½ã‚’ãŠè€ƒãˆã§ã™ã‹ï¼Ÿã€
```

---

#### ã‚±ãƒ¼ã‚¹2: æ–°ã—ã„æŠ€è¡“ã‚’å­¦ç¿’ä¸­

**ç®¡ç†ç”»é¢ã§ã®æ“ä½œ:**
```
ã‚«ãƒ†ã‚´ãƒª: recent_updates
ã‚­ãƒ¼: learning_rust
å€¤: Rustè¨€èªã‚’å­¦ç¿’ä¸­ï¼ˆ2026å¹´1æœˆã€œï¼‰
å„ªå…ˆåº¦: 80
```

**AIã®ä¼šè©±ä¾‹:**
```
è¨ªå•è€…: ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé‡è¦ãªAPIã‚’ä½œã‚ŠãŸã„ã€

AI: ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã§ã™ã­ï¼
Node.jsã‚„GoãŒé¸æŠè‚¢ã«ãªã‚Šã¾ã™ãŒã€å®Ÿã¯çŸ³å·ã•ã‚“ã‚‚æœ€è¿‘Rustã‚’å­¦ç¿’ã—å§‹ã‚ã¦ã‚‹ã‚“ã§ã™ã€‚
è¶…é«˜é€ŸãªAPIãŒå¿…è¦ãªã‚‰Rustã‚‚æ¤œè¨ã§ãã¾ã™ã‚ˆã€‚

ãŸã ã—é–‹ç™ºé€Ÿåº¦ã‚’å„ªå…ˆã™ã‚‹ãªã‚‰ã€ã¾ãšã¯Next.js + Supabaseã§å§‹ã‚ã¦ã€
ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒè¦‹ã¤ã‹ã£ã¦ã‹ã‚‰Rustã§ãƒªãƒ—ãƒ¬ãƒ¼ã‚¹ã™ã‚‹ã®ã‚‚ã‚¢ãƒªã§ã™ğŸ‘ã€
```

---

### ã¾ã¨ã‚

| æ©Ÿèƒ½ | èª¬æ˜ |
|------|------|
| **profile_data ãƒ†ãƒ¼ãƒ–ãƒ«** | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿å­˜ |
| **ã‚«ãƒ†ã‚´ãƒªåˆ†é¡** | basic, skills, hobbies, recent_updates, achievements, personality |
| **å„ªå…ˆåº¦åˆ¶å¾¡** | 0-100ã§ä¼šè©±ã§ã®è¨€åŠé »åº¦ã‚’èª¿æ•´ |
| **ç®¡ç†ç”»é¢ã§ç·¨é›†** | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° |
| **AIã«è‡ªå‹•åæ˜ ** | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å‹•çš„ã«çµ„ã¿è¾¼ã¿ |
| **è‡ªç„¶ãªä¼šè©±** | æŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªãã€æ–‡è„ˆã«å¿œã˜ã¦è¨€åŠ |

**çŸ³å·ã•ã‚“ãŒãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgé”æˆã—ãŸã‚‰ã€ç®¡ç†ç”»é¢ã§3åˆ†ã§è¿½åŠ  â†’ å³åº§ã«AIãŒè¨ªå•è€…ã«ä¼ãˆã‚‹ï¼** ğŸ‰

---

### RAGã«ã‚ˆã‚‹é•·æœŸè¨˜æ†¶

```typescript
// lib/openai/embeddings.ts
import { openai } from './client';
import { supabase } from '@/lib/supabase/server';

/**
 * ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ
 */
export async function createEmbedding(text: string): Promise<number[]> {
  const response = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: text,
  });
  
  return response.data[0].embedding;
}

/**
 * é–¢é€£ã™ã‚‹éå»ã®ä¼šè©±ã‚’æ¤œç´¢
 */
export async function searchRelevantConversations(
  query: string,
  visitorId: string,
  limit: number = 3
): Promise<string[]> {
  // ã‚¯ã‚¨ãƒªã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ
  const queryEmbedding = await createEmbedding(query);
  
  // ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
  const { data } = await supabase.rpc('match_conversations', {
    query_embedding: queryEmbedding,
    visitor_id: visitorId,
    match_threshold: 0.78,
    match_count: limit
  });
  
  return data.map(d => d.content);
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«RAGæƒ…å ±ã‚’è¿½åŠ 
 */
export async function getEnhancedSystemPrompt(
  visitorId: string,
  currentMessage: string
): Promise<string> {
  const relevantHistory = await searchRelevantConversations(currentMessage, visitorId);
  
  if (relevantHistory.length === 0) {
    return SYSTEM_PROMPT;
  }
  
  return `${SYSTEM_PROMPT}

ã€éå»ã®ä¼šè©±å±¥æ­´ã€‘
${relevantHistory.join('\n\n')}

ä¸Šè¨˜ã®éå»ã®ä¼šè©±ã‚’è¸ã¾ãˆã¦ã€ç¶™ç¶šçš„ã§ä¸€è²«æ€§ã®ã‚ã‚‹å¯¾å¿œã‚’ã—ã¦ãã ã•ã„ã€‚
`;
}
```

---

## GSAP ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

### åŸºæœ¬è¨­å®š

```typescript
// lib/gsap/config.ts
import { gsap } from 'gsap';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

gsap.registerPlugin(ScrollTrigger);

export { gsap };
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// components/animations/MessageAnimation.tsx
'use client';

import { useEffect, useRef } from 'react';
import { gsap } from '@/lib/gsap/config';

export function MessageAnimation({ children }: { children: React.ReactNode }) {
  const messageRef = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    if (!messageRef.current) return;
    
    gsap.fromTo(
      messageRef.current,
      {
        opacity: 0,
        y: 20,
        scale: 0.95,
      },
      {
        opacity: 1,
        y: 0,
        scale: 1,
        duration: 0.4,
        ease: 'power2.out',
      }
    );
  }, []);
  
  return <div ref={messageRef}>{children}</div>;
}
```

### ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// components/animations/PageLoadAnimation.tsx
'use client';

import { useEffect } from 'react';
import { gsap } from '@/lib/gsap/config';

export function PageLoadAnimation() {
  useEffect(() => {
    const tl = gsap.timeline();
    
    tl.from('.hero-title', {
      opacity: 0,
      y: 50,
      duration: 1,
      ease: 'power3.out',
    })
    .from('.chat-container', {
      opacity: 0,
      scale: 0.9,
      duration: 0.8,
      ease: 'back.out(1.7)',
    }, '-=0.5')
    .from('.particles', {
      opacity: 0,
      duration: 1,
    }, '-=0.5');
  }, []);
  
  return null;
}
```

---

## æ‚ªç”¨å¯¾ç­–ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…

### ãªãœå¿…è¦ãªã®ã‹ï¼Ÿ

OpenAI APIã¯**å¾“é‡èª²é‡‘åˆ¶**ã®ãŸã‚ã€æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç„¡åˆ¶é™ã«ä½¿ã‚ã‚Œã‚‹ã¨**ã‚³ã‚¹ãƒˆãŒé’å¤©äº•**ã«ãªã‚Šã¾ã™ã€‚

**æƒ³å®šã•ã‚Œã‚‹æ‚ªç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³:**
1. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹è‡ªå‹•åŒ–æ”»æ’ƒ** - Botã§ç„¡é™ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
2. **Cookieã‚¯ãƒªã‚¢ã«ã‚ˆã‚‹åˆ¶é™å›é¿** - ç„¡æ–™æ ã‚’ä½•åº¦ã‚‚ãƒªã‚»ãƒƒãƒˆ
3. **ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹** - IPåˆ¶é™ã®å›é¿
4. **å¤§é‡ã®ã‚µã‚¤ãƒˆç”Ÿæˆ** - é‡ã„å‡¦ç†ã‚’é€£ç¶šå®Ÿè¡Œã—ã¦ã‚³ã‚¹ãƒˆå¢—å¤§
5. **DDoSæ”»æ’ƒ** - ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã®æ¯æ¸‡

**å¯¾ç­–ã®æ–¹é‡:**
- âœ… **å¤šå±¤é˜²å¾¡** - è¤‡æ•°ã®å¯¾ç­–ã‚’çµ„ã¿åˆã‚ã›ã‚‹
- âœ… **æ®µéšçš„ãªåˆ¶é™** - ç–‘ã‚ã—ã„è¡Œå‹•ã«ã¯å³ã—ãã€é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å„ªã—ã
- âœ… **é€æ˜æ€§** - åˆ¶é™ç†ç”±ã‚’æ˜ç¤ºï¼ˆã€Œã‚ã¨3å›ä½¿ãˆã¾ã™ã€ç­‰ï¼‰
- âœ… **ç®¡ç†ç”»é¢ã§ã®ç›£è¦–** - ç•°å¸¸ã‚’æ—©æœŸç™ºè¦‹

---

## Rate Limitingï¼ˆä½¿ç”¨åˆ¶é™ï¼‰

### ç›®çš„
- OpenAI APIã‚³ã‚¹ãƒˆã®åˆ¶å¾¡
- ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¬å¹³ãªåˆ©ç”¨æ©Ÿä¼šç¢ºä¿
- ã‚µãƒ¼ãƒãƒ¼ãƒªã‚½ãƒ¼ã‚¹ã®ä¿è­·

### å®Ÿè£…æ–¹å¼ï¼šUpstash Redis + Tieråˆ¶

#### ãªãœUpstash Redisãªã®ã‹ï¼Ÿ

| æ¯”è¼ƒé …ç›® | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆPostgreSQLï¼‰ | Upstash Redis |
|---------|--------------------------|--------------|
| **é€Ÿåº¦** | 10-50ms | **1-5ms** âš¡ |
| **ã‚³ã‚¹ãƒˆ** | Supabaseç„¡æ–™æ ã‚’æ¶ˆè²» | **å®Œå…¨ç„¡æ–™ï¼ˆ1ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ï¼‰** |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã§è² è·å¢— | **é«˜é€Ÿåˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥** |
| **å®Ÿè£…é›£æ˜“åº¦** | ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…ãŒå¿…è¦ | **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ç°¡å˜** |

**çµè«–**: Redis ã¯ Rate Limiting ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹

---

### Tieråˆ¥ã®åˆ¶é™è¨­è¨ˆ

| Tier | æ¡ä»¶ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ¶é™ | ã‚µã‚¤ãƒˆç”Ÿæˆ | ãƒªã‚»ãƒƒãƒˆ |
|------|------|--------------|----------|---------|
| **Tier 1ï¼ˆåŒ¿åï¼‰** | åˆå›è¨ªå• | **5å›/æ—¥** | âŒ ä¸å¯ | æ¯æ—¥0æ™‚ï¼ˆJSTï¼‰ |
| **Tier 2ï¼ˆåå‰ï¼‰** | ä¼šè©±å†…ã§åå‰ã‚’ç™»éŒ² | **10å›/æ—¥** | âœ… 1å›/æ—¥ | æ¯æ—¥0æ™‚ï¼ˆJSTï¼‰ |
| **Tier 3ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰** | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ² | **30å›/æ—¥** | âœ… 3å›/æ—¥ | æ¯æ—¥0æ™‚ï¼ˆJSTï¼‰ |
| **Tier 4ï¼ˆå•ã„åˆã‚ã›ï¼‰** | æ­£å¼ã«å•ã„åˆã‚ã›æ¸ˆã¿ | **ç„¡åˆ¶é™** | âœ… ç„¡åˆ¶é™ | - |

---

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

#### 1. Redis ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```typescript
// lib/rate-limit/config.ts
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

// Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
export const redis = Redis.fromEnv();

/**
 * Tieråˆ¥ã®Rate Limiter
 * slidingWindow = æŒ‡å®šæœŸé–“å†…ã®ç´¯è¨ˆå›æ•°ã§åˆ¶é™
 */
export const rateLimiters = {
  // Tier 1: 1æ—¥5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  tier1: new Ratelimit({
    redis,
    limiter: Ratelimit.slidingWindow(5, '24 h'),
    analytics: true, // Upstashãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§åˆ†æå¯èƒ½
    prefix: 'ratelimit:tier1',
  }),
  
  // Tier 2: 1æ—¥10ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  tier2: new Ratelimit({
    redis,
    limiter: Ratelimit.slidingWindow(10, '24 h'),
    analytics: true,
    prefix: 'ratelimit:tier2',
  }),
  
  // Tier 3: 1æ—¥30ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  tier3: new Ratelimit({
    redis,
    limiter: Ratelimit.slidingWindow(30, '24 h'),
    analytics: true,
    prefix: 'ratelimit:tier3',
  }),
};

/**
 * ã‚µã‚¤ãƒˆç”Ÿæˆç”¨ã®Rate Limiterï¼ˆã‚ˆã‚Šå³ã—ã„åˆ¶é™ï¼‰
 */
export const siteGenerationLimiters = {
  tier2: new Ratelimit({
    redis,
    limiter: Ratelimit.slidingWindow(1, '24 h'),
    analytics: true,
    prefix: 'ratelimit:sitegen:tier2',
  }),
  tier3: new Ratelimit({
    redis,
    limiter: Ratelimit.slidingWindow(3, '24 h'),
    analytics: true,
    prefix: 'ratelimit:sitegen:tier3',
  }),
};
```

#### 2. Rate Limit ãƒã‚§ãƒƒã‚¯é–¢æ•°

```typescript
// lib/rate-limit/check.ts
import { rateLimiters, siteGenerationLimiters } from './config';

export type RateLimitResult = {
  success: boolean;        // åˆ¶é™å†…ã‹ï¼Ÿ
  remaining: number;       // æ®‹ã‚Šå›æ•°
  reset: number;           // ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ï¼ˆUnix timestampï¼‰
  limit: number;           // åˆ¶é™æ•°
};

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®Rate Limitãƒã‚§ãƒƒã‚¯
 */
export async function checkMessageRateLimit(
  visitorId: string,
  tier: number
): Promise<RateLimitResult> {
  // Tier 4ï¼ˆå•ã„åˆã‚ã›æ¸ˆã¿ï¼‰ã¯ç„¡åˆ¶é™
  if (tier === 4) {
    return {
      success: true,
      remaining: 999999,
      reset: 0,
      limit: 999999,
    };
  }
  
  // Tier ã«å¿œã˜ãŸLimiterã‚’å–å¾—
  const limiter = rateLimiters[`tier${tier}` as keyof typeof rateLimiters];
  
  if (!limiter) {
    throw new Error(`Invalid tier: ${tier}`);
  }
  
  // Rate Limit ãƒã‚§ãƒƒã‚¯
  const result = await limiter.limit(visitorId);
  
  return {
    success: result.success,
    remaining: result.remaining,
    reset: result.reset,
    limit: result.limit,
  };
}

/**
 * ã‚µã‚¤ãƒˆç”Ÿæˆã®Rate Limitãƒã‚§ãƒƒã‚¯
 */
export async function checkSiteGenerationRateLimit(
  visitorId: string,
  tier: number
): Promise<RateLimitResult> {
  // Tier 1 ã¯ç”Ÿæˆä¸å¯
  if (tier === 1) {
    return {
      success: false,
      remaining: 0,
      reset: 0,
      limit: 0,
    };
  }
  
  // Tier 4 ã¯ç„¡åˆ¶é™
  if (tier === 4) {
    return {
      success: true,
      remaining: 999999,
      reset: 0,
      limit: 999999,
    };
  }
  
  const limiter = siteGenerationLimiters[`tier${tier}` as keyof typeof siteGenerationLimiters];
  
  if (!limiter) {
    throw new Error(`Invalid tier: ${tier}`);
  }
  
  const result = await limiter.limit(visitorId);
  
  return {
    success: result.success,
    remaining: result.remaining,
    reset: result.reset,
    limit: result.limit,
  };
}
```

#### 3. APIã§ã®ä½¿ç”¨ä¾‹

```typescript
// app/api/chat/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { checkMessageRateLimit } from '@/lib/rate-limit/check';
import { getVisitorTier } from '@/lib/visitor/identification';

export async function POST(req: NextRequest) {
  const { message, visitorId } = await req.json();
  
  // è¨ªå•è€…ã®Tierã‚’å–å¾—
  const tier = await getVisitorTier(visitorId);
  
  // Rate Limit ãƒã‚§ãƒƒã‚¯
  const rateLimit = await checkMessageRateLimit(visitorId, tier);
  
  if (!rateLimit.success) {
    return NextResponse.json(
      {
        error: 'rate_limit_exceeded',
        message: 'æœ¬æ—¥ã®ä½¿ç”¨å›æ•°ã‚’è¶…ãˆã¾ã—ãŸ',
        remaining: rateLimit.remaining,
        reset: rateLimit.reset,
        upgradeInfo: getUpgradeMessage(tier), // Tierã‚¢ãƒƒãƒ—ã®ææ¡ˆ
      },
      {
        status: 429,
        headers: {
          'X-RateLimit-Limit': rateLimit.limit.toString(),
          'X-RateLimit-Remaining': rateLimit.remaining.toString(),
          'X-RateLimit-Reset': rateLimit.reset.toString(),
        },
      }
    );
  }
  
  // ãƒãƒ£ãƒƒãƒˆå‡¦ç†...
  // ...
}

function getUpgradeMessage(tier: number): string {
  switch (tier) {
    case 1:
      return 'ãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ãã¨ã€1æ—¥10å›ã¾ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ğŸ˜Š';
    case 2:
      return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€1æ—¥30å›ã¾ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼';
    case 3:
      return 'è©³ã—ãç›¸è«‡ã—ãŸã„å ´åˆã¯ã€ãŠå•ã„åˆã‚ã›ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚';
    default:
      return '';
  }
}
```

---

## IPåˆ¶é™ãƒ»ç•°å¸¸æ¤œçŸ¥

### ç›®çš„
- åŒä¸€IPã‹ã‚‰ã®å¤§é‡ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ã
- DDoSæ”»æ’ƒã®æ¤œçŸ¥
- ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®æ‚ªç”¨ã‚’æ¤œçŸ¥

### å®Ÿè£…æ–¹å¼ï¼šRedis + ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

#### ä»•çµ„ã¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡                          â”‚
â”‚  IP: 192.168.1.100                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redisã§ã‚«ã‚¦ãƒ³ãƒˆ                         â”‚
â”‚  Key: ip:192.168.1.100:2026-01-25      â”‚
â”‚  Value: 125 (ä»Šæ—¥ã®ã‚¢ã‚¯ã‚»ã‚¹æ•°)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é–¾å€¤ãƒã‚§ãƒƒã‚¯                            â”‚
â”‚  - 100å›/æ™‚é–“ â†’ âš ï¸ è­¦å‘Š                â”‚
â”‚  - 500å›/æ—¥ â†’ ğŸš« ãƒ–ãƒ­ãƒƒã‚¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```typescript
// lib/security/ip-limiting.ts
import { redis } from '@/lib/rate-limit/config';

const IP_LIMITS = {
  perHour: 100,      // 1æ™‚é–“ã‚ãŸã‚Š100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  perDay: 500,       // 1æ—¥ã‚ãŸã‚Š500ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  blockDuration: 3600, // ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ï¼ˆç§’ï¼‰ = 1æ™‚é–“
};

/**
 * IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œï¼‰
 */
export function getClientIP(req: NextRequest): string {
  // Vercelã®å ´åˆ
  const forwardedFor = req.headers.get('x-forwarded-for');
  if (forwardedFor) {
    return forwardedFor.split(',')[0].trim();
  }
  
  // CloudFlareã®å ´åˆ
  const cfIP = req.headers.get('cf-connecting-ip');
  if (cfIP) return cfIP;
  
  // ãã®ä»–
  return req.headers.get('x-real-ip') || 'unknown';
}

/**
 * IPåˆ¶é™ãƒã‚§ãƒƒã‚¯
 */
export async function checkIPLimit(ip: string): Promise<{
  allowed: boolean;
  reason?: string;
  remaining?: number;
}> {
  const now = Date.now();
  const today = new Date().toISOString().split('T')[0];
  const currentHour = new Date().getHours();
  
  // ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
  const isBlocked = await redis.get(`ip:blocked:${ip}`);
  if (isBlocked) {
    return {
      allowed: false,
      reason: 'IP address is blocked due to suspicious activity',
    };
  }
  
  // 1æ™‚é–“ã‚ãŸã‚Šã®ã‚«ã‚¦ãƒ³ãƒˆ
  const hourKey = `ip:${ip}:hour:${today}:${currentHour}`;
  const hourCount = await redis.incr(hourKey);
  await redis.expire(hourKey, 3600); // 1æ™‚é–“ã§è‡ªå‹•å‰Šé™¤
  
  if (hourCount > IP_LIMITS.perHour) {
    // ä¸€æ™‚ãƒ–ãƒ­ãƒƒã‚¯
    await redis.setex(`ip:blocked:${ip}`, IP_LIMITS.blockDuration, 'auto-blocked');
    
    // ç®¡ç†è€…ã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    await notifyAdmin(`IP ${ip} was auto-blocked (${hourCount} requests/hour)`);
    
    return {
      allowed: false,
      reason: 'Too many requests per hour',
    };
  }
  
  // 1æ—¥ã‚ãŸã‚Šã®ã‚«ã‚¦ãƒ³ãƒˆ
  const dayKey = `ip:${ip}:day:${today}`;
  const dayCount = await redis.incr(dayKey);
  await redis.expire(dayKey, 86400); // 24æ™‚é–“ã§è‡ªå‹•å‰Šé™¤
  
  if (dayCount > IP_LIMITS.perDay) {
    return {
      allowed: false,
      reason: 'Daily limit exceeded',
    };
  }
  
  return {
    allowed: true,
    remaining: IP_LIMITS.perDay - dayCount,
  };
}

/**
 * ç®¡ç†è€…ã«é€šçŸ¥ï¼ˆSlackãªã©ï¼‰
 */
async function notifyAdmin(message: string) {
  // Slack Webhookç­‰ã§é€šçŸ¥
  console.error('[SECURITY ALERT]', message);
  
  // å°†æ¥çš„ã«ã¯Slacké€£æº
  // await fetch(process.env.SLACK_WEBHOOK_URL, {
  //   method: 'POST',
  //   body: JSON.stringify({ text: message }),
  // });
}
```

#### Middlewareã§ã®é©ç”¨

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server';
import { checkIPLimit, getClientIP } from '@/lib/security/ip-limiting';

export async function middleware(req: NextRequest) {
  // ç®¡ç†ç”»é¢ã¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿ãƒã‚§ãƒƒã‚¯
  if (req.nextUrl.pathname.startsWith('/api') || 
      req.nextUrl.pathname.startsWith('/admin')) {
    
    const ip = getClientIP(req);
    const ipCheck = await checkIPLimit(ip);
    
    if (!ipCheck.allowed) {
      return NextResponse.json(
        { error: 'Too many requests', reason: ipCheck.reason },
        { status: 429 }
      );
    }
  }
  
  return NextResponse.next();
}

export const config = {
  matcher: ['/api/:path*', '/admin/:path*'],
};
```

---

## Botæ¤œçŸ¥ï¼ˆè¡Œå‹•åˆ†æï¼‰

### ç›®çš„
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹è‡ªå‹•åŒ–æ”»æ’ƒã‚’æ¤œçŸ¥
- äººé–“ã®è‡ªç„¶ãªæ“ä½œã¨Botã‚’åŒºåˆ¥
- æ‚ªè³ªãªã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯

### å®Ÿè£…æ–¹å¼ï¼šè¤‡æ•°ã®æŒ‡æ¨™ã‚’çµ„ã¿åˆã‚ã›ãŸåˆ¤å®š

#### æ¤œçŸ¥æŒ‡æ¨™

| æŒ‡æ¨™ | äººé–“ | Bot | åˆ¤å®š |
|------|------|-----|------|
| **ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”** | 5-30ç§’ | <1ç§’ | âš ï¸ ä¸è‡ªç„¶ã«é€Ÿã„ |
| **User Agent** | æ­£å¸¸ | ç©º or å½è£… | âš ï¸ ç–‘ã‚ã—ã„ |
| **JavaScriptå®Ÿè¡Œ** | âœ… | âŒ | âŒ ç„¡åŠ¹åŒ–ã—ã¦ã„ã‚‹ |
| **ãƒã‚¦ã‚¹ç§»å‹•** | ã‚ã‚Š | ãªã— | âš ï¸ æ“ä½œç—•è·¡ãªã— |
| **åŒä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** | æ¯å›é•ã† | åŒã˜ | âš ï¸ ã‚³ãƒ”ãƒšé€£æŠ• |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“** | æ•°åˆ†ä»¥ä¸Š | <10ç§’ | âš ï¸ å³é›¢è„± |

#### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```typescript
// lib/security/bot-detection.ts
import { redis } from '@/lib/rate-limit/config';

export type BotScore = {
  score: number;        // 0-100ï¼ˆé«˜ã„ã»ã©æ€ªã—ã„ï¼‰
  isBot: boolean;       // é–¾å€¤è¶…ãˆã§Botåˆ¤å®š
  reasons: string[];    // åˆ¤å®šç†ç”±
};

/**
 * Botåˆ¤å®šã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
 */
export async function detectBot(params: {
  visitorId: string;
  ip: string;
  userAgent: string;
  timeSinceLastRequest?: number;  // å‰å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã®ç§’æ•°
  message?: string;
}): Promise<BotScore> {
  const { visitorId, ip, userAgent, timeSinceLastRequest, message } = params;
  
  let score = 0;
  const reasons: string[] = [];
  
  // 1. User Agent ãƒã‚§ãƒƒã‚¯
  if (!userAgent || userAgent.length < 10) {
    score += 40;
    reasons.push('Invalid User Agent');
  } else if (userAgent.toLowerCase().includes('bot') || 
             userAgent.toLowerCase().includes('crawler')) {
    score += 50;
    reasons.push('Bot/Crawler in User Agent');
  }
  
  // 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ãƒã‚§ãƒƒã‚¯
  if (timeSinceLastRequest !== undefined && timeSinceLastRequest < 2) {
    score += 30;
    reasons.push('Too fast requests (< 2s)');
  }
  
  // 3. åŒä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€£æŠ•ãƒã‚§ãƒƒã‚¯
  if (message) {
    const lastMessage = await redis.get(`last_msg:${visitorId}`);
    if (lastMessage === message) {
      score += 25;
      reasons.push('Duplicate message');
    }
    await redis.setex(`last_msg:${visitorId}`, 300, message); // 5åˆ†ä¿å­˜
  }
  
  // 4. çŸ­æ™‚é–“ã§ã®å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  const recentCount = await redis.incr(`bot_check:${visitorId}:${Math.floor(Date.now() / 60000)}`);
  await redis.expire(`bot_check:${visitorId}:${Math.floor(Date.now() / 60000)}`, 60);
  
  if (recentCount > 10) {
    score += 40;
    reasons.push('Too many requests in 1 minute');
  }
  
  // 5. Fingerprintã®é »ç¹ãªå¤‰æ›´ï¼ˆCookieã‚¯ãƒªã‚¢æ”»æ’ƒï¼‰
  const fpChangeCount = await redis.get(`fp_changes:${ip}`);
  if (fpChangeCount && parseInt(fpChangeCount) > 5) {
    score += 20;
    reasons.push('Frequent fingerprint changes');
  }
  
  return {
    score,
    isBot: score >= 60, // é–¾å€¤60ç‚¹ä»¥ä¸Šã§Botåˆ¤å®š
    reasons,
  };
}

/**
 * Botåˆ¤å®šçµæœã‚’è¨˜éŒ²
 */
export async function recordBotDetection(visitorId: string, result: BotScore) {
  if (result.isBot) {
    // Redisã«è¨˜éŒ²
    await redis.setex(`bot_detected:${visitorId}`, 3600, JSON.stringify(result));
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚‚è¨˜éŒ²ï¼ˆç®¡ç†ç”»é¢ã§ç¢ºèªï¼‰
    await supabase.from('security_logs').insert({
      visitor_id: visitorId,
      event_type: 'bot_detected',
      score: result.score,
      reasons: result.reasons,
      created_at: new Date().toISOString(),
    });
    
    // ç®¡ç†è€…ã«é€šçŸ¥
    console.error(`[BOT DETECTED] Visitor ${visitorId}, Score: ${result.score}`);
  }
}
```

#### APIçµ±åˆä¾‹

```typescript
// app/api/chat/route.ts
import { detectBot, recordBotDetection } from '@/lib/security/bot-detection';

export async function POST(req: NextRequest) {
  const { message, visitorId } = await req.json();
  const userAgent = req.headers.get('user-agent') || '';
  const ip = getClientIP(req);
  
  // å‰å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚åˆ»ã‚’å–å¾—
  const lastRequestTime = await redis.get(`last_req:${visitorId}`);
  const now = Date.now();
  const timeSinceLastRequest = lastRequestTime 
    ? (now - parseInt(lastRequestTime)) / 1000 
    : undefined;
  
  await redis.setex(`last_req:${visitorId}`, 3600, now.toString());
  
  // Botåˆ¤å®š
  const botCheck = await detectBot({
    visitorId,
    ip,
    userAgent,
    timeSinceLastRequest,
    message,
  });
  
  if (botCheck.isBot) {
    await recordBotDetection(visitorId, botCheck);
    
    return NextResponse.json(
      { 
        error: 'Suspicious activity detected',
        message: 'ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
      },
      { status: 403 }
    );
  }
  
  // æ­£å¸¸ãªå‡¦ç†...
}
```

---

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®è£œåŠ©çš„ãªå¯¾ç­–

#### Honeypotï¼ˆéš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰

```tsx
// components/chat/ChatInput.tsx
export function ChatInput() {
  return (
    <form onSubmit={handleSubmit}>
      <textarea name="message" />
      
      {/* Honeypot: Botã¯è¦‹ãˆãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚åŸ‹ã‚ã¦ã—ã¾ã† */}
      <input
        type="text"
        name="website"
        tabIndex={-1}
        autoComplete="off"
        style={{ position: 'absolute', left: '-9999px' }}
      />
      
      <button type="submit">é€ä¿¡</button>
    </form>
  );
}
```

```typescript
// ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒã‚§ãƒƒã‚¯
if (formData.get('website')) {
  // HoneypotãŒåŸ‹ã‚ã‚‰ã‚Œã¦ã„ã‚‹ = Bot
  return NextResponse.json({ error: 'Bot detected' }, { status: 403 });
}
```

---

### ã¾ã¨ã‚

| å¯¾ç­– | ç›®çš„ | å®Ÿè£…æ–¹æ³• | ã‚³ã‚¹ãƒˆ |
|------|------|---------|--------|
| **Rate Limiting** | ä½¿ç”¨å›æ•°åˆ¶é™ | Upstash Redis + Tieråˆ¶ | ç„¡æ–™ |
| **IPåˆ¶é™** | å¤§é‡ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ | Redis ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ | ç„¡æ–™ |
| **Botæ¤œçŸ¥** | è‡ªå‹•åŒ–æ”»æ’ƒé˜²æ­¢ | ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æ–¹å¼ | ç„¡æ–™ |
| **Honeypot** | Botåˆ¤åˆ¥ | éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | ç„¡æ–™ |
| **Fingerprinting** | Cookieå›é¿å¯¾ç­– | FingerprintJS | ç„¡æ–™ |

**ç·åˆçš„ãªé˜²å¾¡ã§ã€ã‚³ã‚¹ãƒˆ0å††ã§å …ç‰¢ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å®Ÿç¾** âœ¨

---

## ç’°å¢ƒå¤‰æ•°

```.env
# .env.local
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# OpenAI
OPENAI_API_KEY=sk-...

# Upstash Redis
UPSTASH_REDIS_REST_URL=https://...
UPSTASH_REDIS_REST_TOKEN=...

# ãã®ä»–
NEXT_PUBLIC_APP_URL=https://yoursite.com
ADMIN_EMAIL=ishikawa@example.com
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆVercelï¼‰

### vercel.json

```json
{
  "buildCommand": "next build",
  "devCommand": "next dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["hnd1"],
  "env": {
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase-url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase-anon-key",
    "SUPABASE_SERVICE_ROLE_KEY": "@supabase-service-role-key",
    "OPENAI_API_KEY": "@openai-api-key",
    "UPSTASH_REDIS_REST_URL": "@upstash-redis-url",
    "UPSTASH_REDIS_REST_TOKEN": "@upstash-redis-token"
  }
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### Next.jsè¨­å®š

```typescript
// next.config.ts
const config = {
  experimental: {
    serverActions: {
      bodySizeLimit: '2mb',
    },
  },
  images: {
    domains: ['your-supabase-project.supabase.co'],
  },
  // GSAPç­‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœ€é©åŒ–
  webpack: (config) => {
    config.resolve.alias = {
      ...config.resolve.alias,
      'gsap': 'gsap/dist/gsap.min.js',
    };
    return config;
  },
};

export default config;
```

### ã‚³ãƒ¼ãƒ‰åˆ†å‰²

```typescript
// å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const ParticleBackground = dynamic(
  () => import('@/components/animations/ParticleBackground'),
  { ssr: false } // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ã¿
);

const AdminDashboard = dynamic(
  () => import('@/components/admin/Dashboard'),
  { loading: () => <LoadingSpinner /> }
);
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### Content Security Policy

```typescript
// middleware.ts
export function middleware(request: NextRequest) {
  const response = NextResponse.next();
  
  response.headers.set(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
  );
  
  return response;
}
```

### iframe Sandbox

```tsx
<iframe
  srcDoc={generatedCode}
  sandbox="allow-scripts allow-same-origin"
  className="w-full h-full"
/>
```

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: UIè¨­è¨ˆæ›¸ã‚’ä½œæˆï¼
